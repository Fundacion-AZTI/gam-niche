---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Prepare final dataset

Loading required libraries

```{r, eval=F}
# library(rgdal) # to read shp
# library(raster) # to work with rasters
# library (here) # Libraries for reproducible workflow
# library (sp)     # to perform raster
# library(HH) #to calculate for VIF (Variance Inflation Factor)
# library(ggplot2)# plots
# library(gridExtra)# multiple plots
# library(dplyr)
# library(RColorBrewer)#plotting colors
# library(fields)#ploting images
# library(marmap)#ploting world
# library(maptools)#mapping
# library(rstudioapi)
```

## Extract environmental data associated to presence-absence data

Once the environmental rasters and the species abundance data (including pseudo-absences) have been prepared, we need to merge both sources of data. 



```{r, eval=F}

# location of script
#setwd(dirname(getSourceEditorContext()$path))

#load data
load("data/outputs_for_modelling/PAdata.RData")
load(file="data/env/myBioracle.layers.Rdata") 
```

For that we extract the environmental data associated to each of the species data points using the function `extract` from the `raster` package:

### Extract environmental values from layers 

```{r, eval=F}
# con Bilinear extraigo los sites de los 4 nearest cells 
mydata1.env.bil <- raster::extract(x=myBioracle.layers,y=dat[,c("LON","LAT")], method="bilinear", na.rm=TRUE, df=T) # 4 nearest cells, se consigue valor 29 sites más (se siguen perdiendo 64, de los cuales algunos son errores, es decir, no costeros)

# merge with pa data
data <- cbind(dat, mydata1.env.bil)

# remove positive bathymetries

data<-subset(data,BO_bathymean<0)

summary(data) # 29435 sites : 4 are NAs

#save data frame

save(list="data",file=file.path("data","outputs_for_modelling",file="PAdata_with_env.RData"))

```

## Variable correlation: Analysis of Variance Inflation Factor (VIF) 

<!-- #Nota interna: copio el script de analísis VIF para las variables superficiales del proyecto MISSION -->

<!-- ### Script information -->

With this script we assess the correlation between environmental variables based on Variance Inflation Factor (VIF) by depth set 

Project: IM-20-MISSION

VIF is a measure of the amount of multicollinearity in regression analysis

VIF equal to 1 = variables are not correlated
VIF between 1 and 5 = variables are moderately correlated 
VIF greater than 5 = variables are highly correlated

If you found high multicollinearity between two variables, you don’t need both of them in your model.

```{r, eval=F}

# select variables for vif calculation

v_table <- data %>% 
  dplyr::select (BO2_salinitymean_ss,BO_sstmean,BO2_chlomean_ss,BO_damean)

##### get vif results

resultado.vif <- vif(v_table)
sort(resultado.vif)

#remove highest

v_table <- v_table %>% 
  dplyr::select (-BO_damean)

##### get new vif results

resultado.vif <- vif(v_table)
sort(resultado.vif)


#save data frame without correlated variable

data <- data %>% dplyr::select (-BO_damean)
save(list="data",file=file.path("data","outputs_for_modelling",file="PAdata_with_env.RData"))

```

## Exploratory plots

```{r, eval=F}
####Leo archivos de especies de peces SP

load(file.path ("data", "outputs_for_modelling", "PAdata_with_env.Rdata"))

occ <- data %>% 
  dplyr::filter(data$occurrenceStatus == 1)

abs <- data %>% 
  dplyr::filter(data$occurrenceStatus == 0)

#NOTA INTERNA: El número de ausencias es mayor que las presencias, creo que tiene que ver con haber elimanado los datos de batimetrías menores que 0
  
##Salvo el pdf
pdf(file=file.path("results", "factsheets_env.pdf"), paper="a4", width=, height=12,compress=T)


  par(mfrow=c(3,3)) 
  
  names (data)

  #### 1 BO_bathymean: En plot1 una distribucion de densidad de presencias y ausencias vs bathymetry
  
  dens_occ<-density(occ$BO_bathymean,na.rm=T)
  dens_abs<-density(abs$BO_bathymean,na.rm=T)

  plot(dens_occ,xlab="BO_bathymean", ylab="dens", main = "",col="red")
  lines(dens_abs,xlab="BO_bathymean", ylab="dens", main = "",col="blue")

  legend("topleft",legend=c("Occurrences", "Pseudoabsences"),
         col=c("red", "blue"),pch=0.1, cex=0.8,box.lty=0,xpd=TRUE)
  
  ### NOTA INTERNA: hacer los plots para el resto de variables

  #2. "BO_chlomean"  
  dens_occ<-density(occ$BO2_chlomean_ss,na.rm=T)
  dens_abs<-density(abs$BO2_chlomean_ss,na.rm=T)

  plot(dens_occ,xlab="BO2_chlomean_ss", ylab="dens", main = "",col="red")
  lines(dens_abs,xlab="BO2_chlomean_ss", ylab="dens", main = "",col="blue")
  
  #NOTA INTERNA: HAY QUE JUGAR CON LAS ESCALAS

  legend("topright",legend=c("Occurrences", "Pseudoabsences"),
         col=c("red", "blue"),pch=0.1, cex=0.8,box.lty=0,xpd=TRUE)  
  #3. "BO_damean"      
  
  #REPETIR EL DENSITY PLOT DE ARRIBA CAMBIANDO LA VARIABLE
  
  #4. "BO_salinity" 
  
   #REPETIR EL DENSITY PLOT DE ARRIBA CAMBIANDO LA VARIABLE
  
  #5. "BO_sstmean" 
  
   #REPETIR EL DENSITY PLOT DE ARRIBA CAMBIANDO LA VARIABLE
  
  #6. "BO_sstrange" 
  
   #REPETIR EL DENSITY PLOT DE ARRIBA CAMBIANDO LA VARIABLE

 dev.off()
```

