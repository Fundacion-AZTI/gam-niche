% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{book}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{plainnat}
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Species distribution models (SDM)},
  pdfauthor={AZTI},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Species distribution models (SDM)}
\author{AZTI}
\date{2023-01-26}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{about}{%
\chapter*{About}\label{about}}
\addcontentsline{toc}{chapter}{About}

This is a short tutorial for constructing species distribution models in R using shape-constrained generalized additive models.

The code is available in \href{https://github.com/Fundacion-AZTI/SDM}{AZTI's github repository} repository and the book is readily available \href{https://fundacion-azti.github.io/SDM/}{here}.

To cite this book, please use:

BLA BLA BLA

\hypertarget{introduction}{%
\chapter{Introduction}\label{introduction}}

Species distribution models (SDMs) are numerical tools that combine observations of species occurrence or abundance at known locations with information on the environmental and/or spatial characteristics of those locations \citep{elith_etal_2009}. They are also known as ecological niche models (ENM) or habitat suitability models or\ldots{}

A wide variety of methods have been used \ldots{}

Reviews of SDM literature include \ldots{}

One of the common problems is that, the fitted models do not agree with the ecological niche theory\ldots{}

This book provides a tutorial on how to use shape-constrained generalized additive models to build SDMs. It is organised following the key steps in good modeling practice of SDMs \citep{elith_etal_2009}. First, presence data of a selected species are downloaded from GBIF/OBIS datasets and pseudo-absence data are created. Then, environmental data are downloaded from public repositories and extracted at each of the presence/pseudo-absence data points. Based on this dataset, an exploratory analysis is conducted to help deciding on the best modelling approach. The model is fitted to the dataset and the quality of the fit and the realism of the fitted response function are evaluated. After selecting a threshold to transform the continuous probability predictions into binary responses, the model is validated using a k-fold approach. Finally, the predicted maps are generated for visualization.

\hypertarget{libraries}{%
\chapter{Libraries}\label{libraries}}

Load libraries that will be used

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(}\StringTok{"scam"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Loading required package: mgcv
\end{verbatim}

\begin{verbatim}
## Loading required package: nlme
\end{verbatim}

\begin{verbatim}
## This is mgcv 1.8-39. For overview type 'help("mgcv-package")'.
\end{verbatim}

\begin{verbatim}
## This is scam 1.2-12.
\end{verbatim}

Note that all the libraries must be installed. If some library is not installed, run:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"scam"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'scam' is in use and will not be installed
\end{verbatim}

\hypertarget{presence-absence-data}{%
\chapter{Presence-absence data}\label{presence-absence-data}}

Bla bla bla

\hypertarget{download-presence-data}{%
\section{Download presence data}\label{download-presence-data}}

Download from GBIF OBIS. Mireia

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Script information {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# Title: Download OBIS/GBIF occurrence data used in H2020 Mission Atlantic (No 862428) Project Task 3.4.}
\CommentTok{\# Last modified by Mireia Valle (github profile: MireiaValle, email: mvalle@azti.es) based on original code for sourcing OBIS and GBIF from Guillem Chust (email: gchust@azti.es) and some adaptations from Eduardo Ramirez. }

\CommentTok{\# Load libraries }
\SpecialCharTok{{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  
\CommentTok{\# Specific libraries to get the occurrence data}
\CommentTok{\#install.packages("robis") \# https://cran.r{-}project.org/web/packages/robis/robis.pdf}
\FunctionTok{library}\NormalTok{(robis)}
\FunctionTok{library}\NormalTok{ (rgbif)}

\CommentTok{\# Libraries for Spatial data }
\FunctionTok{library}\NormalTok{(rgdal)}
\FunctionTok{library}\NormalTok{(sf) }\CommentTok{\# shapes}

\CommentTok{\# Library for plotting}
\FunctionTok{library}\NormalTok{(ggplot2)}

\CommentTok{\# Libraries for reading data}
\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(tidyr)}

\CommentTok{\# outliers}
\FunctionTok{library}\NormalTok{(CoordinateCleaner)}

\CommentTok{\# Library for reproducible workflow}
\FunctionTok{library}\NormalTok{(here)}


\CommentTok{\# STUDY AREA}
\SpecialCharTok{{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\DocumentationTok{\#\#NOTA interna: En el código de MISSION uso el shapefile de FAO que lo tengo descargado en el ordenador, hay que añadir la info para la descarga manual o el código para la descarga con R. Para MISSION elimino el Black Sea del área de estudio. }
  
\CommentTok{\# el enlace para la descarga del shapefile es el siguiente: }
 
\CommentTok{\# http://www.fao.org/fishery/geoserver/fifao/ows?service=WFS\&request=GetFeature\&version=1.0.0\&typeName=fifao:FAO\_AREAS\_CWP\&outputFormat=SHAPE{-}ZIP")}

\CommentTok{\# Load FAO (spatial multipolygon)}
\NormalTok{FAO}\OtherTok{\textless{}{-}} \FunctionTok{readOGR}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"spatial"}\NormalTok{, }\StringTok{"FAO\_AREAS.shp"}\NormalTok{))}

\CommentTok{\#Selecting Atlantic FAO regions}
\NormalTok{FAO\_Atl }\OtherTok{\textless{}{-}}\NormalTok{ FAO[FAO}\SpecialCharTok{$}\NormalTok{OCEAN}\SpecialCharTok{==}\StringTok{"Atlantic"}\NormalTok{,]}

\CommentTok{\#Plot Atlantic FAO regions}
\FunctionTok{plot}\NormalTok{(FAO\_Atl)}

\CommentTok{\#remove Black Sea subarea}

\NormalTok{Black\_Sea }\OtherTok{\textless{}{-}}\NormalTok{ FAO\_Atl[FAO\_Atl}\SpecialCharTok{$}\NormalTok{ID}\SpecialCharTok{==}\StringTok{"20"}\NormalTok{,]}

\FunctionTok{plot}\NormalTok{(Black\_Sea)}

\DocumentationTok{\#\# Find the \textquotesingle{}difference\textquotesingle{}, i.e. reverse of st\_intersection}

\CommentTok{\# transform to sf object}
\NormalTok{Black\_Sea.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_as\_sf}\NormalTok{(Black\_Sea)}

\NormalTok{FAO\_Atl.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_as\_sf}\NormalTok{(FAO\_Atl)}

\CommentTok{\# remove the black see}
\NormalTok{FAO\_Atl\_no\_black\_sea }\OtherTok{\textless{}{-}} \FunctionTok{st\_difference}\NormalTok{(FAO\_Atl.sf,Black\_Sea.sf) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{   dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{ (F\_AREA)}

\CommentTok{\#transform to spatial polygons dataframe}
\NormalTok{FAO\_Atl\_no\_black\_sea }\OtherTok{\textless{}{-}}\NormalTok{ sf}\SpecialCharTok{:::}\FunctionTok{as\_Spatial}\NormalTok{(FAO\_Atl\_no\_black\_sea)}

\FunctionTok{plot}\NormalTok{(FAO\_Atl\_no\_black\_sea)}

\CommentTok{\# DOWNLOAD DATA FROM OBIS AND GBIF DATASETS AND MERGE }
\SpecialCharTok{{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}  
  
\CommentTok{\# en la reunión decidimos hacer pruebas con: Thunnus alalunga, Thunnus obesus, Xiphias gladius y Thunnus albacares}
  
\DocumentationTok{\#\# Find data by scientific name in the datasets OBIS/GBIF}
  
  \CommentTok{\# Get data from OBIS}
\NormalTok{  mydata.obis}\OtherTok{\textless{}{-}}\NormalTok{robis}\SpecialCharTok{::}\FunctionTok{occurrence}\NormalTok{(}\AttributeTok{scientificname=}\StringTok{"Thunnus alalunga"}\NormalTok{)}

  \CommentTok{\# Get data from GBIF}
\NormalTok{  mydata.gbif}\OtherTok{\textless{}{-}}\FunctionTok{occ\_data}\NormalTok{(}\AttributeTok{scientificName=}\StringTok{"Thunnus alalunga"}\NormalTok{, }\AttributeTok{hasCoordinate =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{limit=}\DecValTok{100000}\NormalTok{)}\SpecialCharTok{$}\NormalTok{data}
  
  \CommentTok{\# Select columns of interest from downloaded data}
  
  \CommentTok{\#check names in for obis data}
  \FunctionTok{names}\NormalTok{(mydata.obis)}
  
  \CommentTok{\#select columns of interest}
\NormalTok{  mydata.obis }\OtherTok{\textless{}{-}}\NormalTok{  mydata.obis }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{                  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\StringTok{"scientificName"}\NormalTok{,}
                   \StringTok{"decimalLongitude"}\NormalTok{,}
                   \StringTok{"decimalLatitude"}\NormalTok{,}
                   \StringTok{"date\_year"}\NormalTok{,}
                   \StringTok{"month"}\NormalTok{,}
                   \StringTok{"day"}\NormalTok{,}
                   \StringTok{"eventDate"}\NormalTok{,}
                   \StringTok{"depth"}\NormalTok{,}
                   \StringTok{"bathymetry"}\NormalTok{,}
                   \StringTok{"occurrenceStatus"}\NormalTok{,}
                   \StringTok{"sst"}\NormalTok{)}
  
  \CommentTok{\# check names for gbif data}
  \FunctionTok{names}\NormalTok{(mydata.gbif)}
  
  \CommentTok{\#select columns of interest}
\NormalTok{  mydata.gbif }\OtherTok{\textless{}{-}}\NormalTok{ mydata.gbif }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{                  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\StringTok{"acceptedScientificName"}\NormalTok{,}
                   \StringTok{"decimalLongitude"}\NormalTok{,}
                   \StringTok{"decimalLatitude"}\NormalTok{,}
                   \StringTok{"year"}\NormalTok{,}
                   \StringTok{"month"}\NormalTok{,}
                   \StringTok{"day"}\NormalTok{,}
                   \StringTok{"eventDate"}\NormalTok{,}
                   \StringTok{"depth"}\NormalTok{)}
  
  \DocumentationTok{\#\# Add new field and rename some columns from mydata.gbif dataframe in order to have the same columns and be able to join both tables}
  
\NormalTok{  mydata.gbif }\OtherTok{\textless{}{-}}\NormalTok{ mydata.gbif }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{scientificName=} \StringTok{"acceptedScientificName"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{date\_year =} \StringTok{"year"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{bathymetry=} \ConstantTok{NA}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{occurrenceStatus=}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{sst=} \ConstantTok{NA}\NormalTok{)}

  \DocumentationTok{\#\# Join data from OBIS and GBIF }
\NormalTok{  mydata.fus}\OtherTok{\textless{}{-}}\FunctionTok{rbind}\NormalTok{(mydata.obis,mydata.gbif)}
  
  \DocumentationTok{\#\# assign unique scientific name }
\NormalTok{  mydata.fus }\OtherTok{\textless{}{-}}\NormalTok{ mydata.fus }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{scientificName=} \FunctionTok{paste}\NormalTok{(mydata.obis}\SpecialCharTok{$}\NormalTok{scientificName[}\DecValTok{1}\NormalTok{]))}
  
\CommentTok{\# CLEAN RAW DATA }
\SpecialCharTok{{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}    
  
  \DocumentationTok{\#\#\#\# give date format to eventDate and fill out month and date\_year columns}
\NormalTok{  mydata.fus}\SpecialCharTok{$}\NormalTok{eventDate }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(mydata.fus}\SpecialCharTok{$}\NormalTok{eventDate)}
\NormalTok{  mydata.fus}\SpecialCharTok{$}\NormalTok{date\_year }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(mydata.fus}\SpecialCharTok{$}\NormalTok{date\_year)}
\NormalTok{  mydata.fus}\SpecialCharTok{$}\NormalTok{month }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(mydata.fus}\SpecialCharTok{$}\NormalTok{month)}

  \DocumentationTok{\#\#\# mutate occurrenceStatus column giving value of 1 to presences and 0 to absences}
\NormalTok{  mydata.fus }\OtherTok{\textless{}{-}}\NormalTok{ mydata.fus }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{occurrenceStatus =} \FunctionTok{ifelse}\NormalTok{(occurrenceStatus}\SpecialCharTok{==} \StringTok{"NA"}\NormalTok{, }\ConstantTok{NA}\NormalTok{, occurrenceStatus)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{occurrenceStatus =} \FunctionTok{ifelse}\NormalTok{(occurrenceStatus}\SpecialCharTok{==} \StringTok{"Present"}\NormalTok{, }\DecValTok{1}\NormalTok{, occurrenceStatus)) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{occurrenceStatus =} \FunctionTok{ifelse}\NormalTok{(occurrenceStatus}\SpecialCharTok{==} \StringTok{"present"}\NormalTok{, }\DecValTok{1}\NormalTok{, occurrenceStatus)) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{occurrenceStatus =} \FunctionTok{ifelse}\NormalTok{(occurrenceStatus}\SpecialCharTok{==} \StringTok{"Presente"}\NormalTok{, }\DecValTok{1}\NormalTok{, occurrenceStatus)) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{occurrenceStatus =} \FunctionTok{ifelse}\NormalTok{(occurrenceStatus}\SpecialCharTok{==} \StringTok{"Presence"}\NormalTok{, }\DecValTok{1}\NormalTok{, occurrenceStatus)) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{occurrenceStatus =} \FunctionTok{ifelse}\NormalTok{(occurrenceStatus}\SpecialCharTok{==} \StringTok{"P"}\NormalTok{, }\DecValTok{1}\NormalTok{, occurrenceStatus)) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{occurrenceStatus =} \FunctionTok{ifelse}\NormalTok{(occurrenceStatus}\SpecialCharTok{==} \StringTok{"Q"}\NormalTok{, }\DecValTok{1}\NormalTok{, occurrenceStatus))}

  \DocumentationTok{\#\#\# Assign 1 value to all retrieved points }
  
  \CommentTok{\#NOTA INTERNA: replace\_na me da error por eso asigno directamente 1 a todos los puntos}
\NormalTok{  mydata.fus }\OtherTok{\textless{}{-}}\NormalTok{ mydata.fus  }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{occurrenceStatus =} \DecValTok{1}\NormalTok{)}

\CommentTok{\# REMOVING OUTLIERS}
\SpecialCharTok{{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}  

  \CommentTok{\# find outliers based on distance method}
\NormalTok{  out.dist }\OtherTok{\textless{}{-}} \FunctionTok{cc\_outl}\NormalTok{(}\AttributeTok{x=}\NormalTok{mydata.fus,}
                \AttributeTok{lon =} \StringTok{"decimalLongitude"}\NormalTok{, }\AttributeTok{lat =} \StringTok{"decimalLatitude"}\NormalTok{,}
                \AttributeTok{species =} \StringTok{"scientificName"}\NormalTok{,}
                \AttributeTok{method=}\StringTok{"distance"}\NormalTok{, }\AttributeTok{tdi=}\DecValTok{1000}\NormalTok{, }\CommentTok{\# distance method with tdi=1000km}
                \AttributeTok{thinning=}\NormalTok{T, }\AttributeTok{thinning\_res=}\FloatTok{0.5}\NormalTok{,}
                \AttributeTok{value=}\StringTok{"flagged"}\NormalTok{) }

  \CommentTok{\# remove outliers from the data}
  
\NormalTok{  mydata.fus }\OtherTok{\textless{}{-}}\NormalTok{ mydata.fus[out.dist, ]}
  
\CommentTok{\# REMOVE DUPLICATES}
\SpecialCharTok{{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}  
\NormalTok{date }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{cbind}\NormalTok{(mydata.fus}\SpecialCharTok{$}\NormalTok{decimalLongitude,mydata.fus}\SpecialCharTok{$}\NormalTok{decimalLatitude,mydata.fus}\SpecialCharTok{$}\NormalTok{eventDate))}

\NormalTok{mydata.fus}\OtherTok{\textless{}{-}}\NormalTok{mydata.fus[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(date),]}

\CommentTok{\# PREPARE DATA TO USE FAO ATLANTIC REGION MASK}
\SpecialCharTok{{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}    
    
  \CommentTok{\# Prepare coordinate format and projection to be able to use FAO zone masks}
\NormalTok{  dat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(mydata.fus}\SpecialCharTok{$}\NormalTok{decimalLongitude,mydata.fus}\SpecialCharTok{$}\NormalTok{decimalLatitude))}
\NormalTok{  ptos}\OtherTok{\textless{}{-}}\FunctionTok{as.data.table}\NormalTok{(dat,}\AttributeTok{keep.columnnames=}\ConstantTok{TRUE}\NormalTok{)}
  
  \FunctionTok{coordinates}\NormalTok{(ptos) }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\NormalTok{ X1 }\SpecialCharTok{+}\NormalTok{ X2}
  
  \FunctionTok{proj4string}\NormalTok{(ptos) }\OtherTok{\textless{}{-}}\FunctionTok{proj4string}\NormalTok{(FAO)}
  
  \DocumentationTok{\#\# Select only occurrences from FAO Atlantic}
\NormalTok{  match2}\OtherTok{\textless{}{-}}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{subset}\NormalTok{(mydata.fus,}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(}\FunctionTok{over}\NormalTok{(ptos, FAO\_Atl\_no\_black\_sea)[,}\DecValTok{1}\NormalTok{])))}
  
  \DocumentationTok{\#\# Extract the FAO area of each point}
\NormalTok{  match3}\OtherTok{\textless{}{-}}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{subset}\NormalTok{(}\FunctionTok{over}\NormalTok{(ptos, FAO\_Atl\_no\_black\_sea), }\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(}\FunctionTok{over}\NormalTok{(ptos, FAO\_Atl\_no\_black\_sea)[,}\DecValTok{1}\NormalTok{])))}
  
\NormalTok{  data\_fus\_Atl}\OtherTok{\textless{}{-}}\FunctionTok{cbind}\NormalTok{(}\AttributeTok{F\_AREA=}\NormalTok{match3}\SpecialCharTok{$}\NormalTok{F\_AREA,match2)}

\CommentTok{\# SAVE OCCURRENCE DATA}
\SpecialCharTok{{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}    

\CommentTok{\#NOTA INTERNA: quiero guardar el RData en la carpeta data/occurrences con el nombre de la especies sin espacios para no machar los RData en caso de que hagamos más de una especie pero no lo consigo. }

\FunctionTok{save}\NormalTok{(data\_fus\_Atl, }\AttributeTok{file =}\NormalTok{ here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{(}\StringTok{"data/occurrences/occ.RData"}\NormalTok{))}

  
\CommentTok{\# PLOT OCCURRENCES MAP}
\SpecialCharTok{{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}   
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
   \FunctionTok{geom\_path}\NormalTok{(}\AttributeTok{data =}\NormalTok{ FAO\_Atl\_no\_black\_sea, }
             \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ long, }\AttributeTok{y =}\NormalTok{ lat, }\AttributeTok{group =}\NormalTok{ group),}
             \AttributeTok{color =} \StringTok{\textquotesingle{}gray\textquotesingle{}}\NormalTok{, }\AttributeTok{size =}\NormalTok{ .}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data=}\NormalTok{data\_fus\_Atl, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{decimalLongitude, }\AttributeTok{y=}\NormalTok{decimalLatitude,}\AttributeTok{colour=}\NormalTok{ occurrenceStatus)) }
\end{Highlighting}
\end{Shaded}

\hypertarget{create-pseudo-absence-data}{%
\section{Create pseudo-absence data}\label{create-pseudo-absence-data}}

Prevalence 50\%

See code from ANICHO (mantaining some space around presences). Leire C.

Ref \citep{barbetmassin_etal_2012}

Copio aqui el codigo de anicho tal cual, luego lo limpiaré para este caso:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Script information {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# Title: Generate pseudo{-}absences for IM{-}18{-}ANICHO}
\CommentTok{\# Last modified by Leire Ibaibarriaga (libaibarriaga@azti.es) and Leire Citores (lcitores@azti.es)}

\CommentTok{\# Load libraries {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(here)}
\FunctionTok{library}\NormalTok{(ggridges)}

\FunctionTok{library}\NormalTok{(maps)        }\CommentTok{\# some basic country maps}
\FunctionTok{library}\NormalTok{(mapdata)     }\CommentTok{\# higher resolution maps}
\FunctionTok{library}\NormalTok{(mapproj)}
\FunctionTok{library}\NormalTok{(marmap)      }\CommentTok{\# access global topography data}
\FunctionTok{library}\NormalTok{(mapplots)    }\CommentTok{\# ices rectangles}
\FunctionTok{library}\NormalTok{(sf)}
\FunctionTok{library}\NormalTok{(gridExtra)}
\FunctionTok{library}\NormalTok{(lubridate)}

\CommentTok{\# general settings for ggplot (black{-}white background, larger base\_size)}

\FunctionTok{theme\_set}\NormalTok{(}\FunctionTok{theme\_bw}\NormalTok{(}\AttributeTok{base\_size =} \DecValTok{16}\NormalTok{))}

\CommentTok{\# Set directories {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# final data set created by Nerea Goikoetxea after combining logboook and VMS data are in:}
\CommentTok{\# \textbackslash{}\textbackslash{}dok\textbackslash{}nas\textbackslash{}K\textbackslash{}AZTIMAR\textbackslash{}PROYECTOS\textbackslash{}Funcionamiento de los ecosistemas marinos\textbackslash{}IM{-}18{-}ANICHO\textbackslash{}Cruce logbooks vs VMS\textbackslash{}Data\textbackslash{}df\_2010\_2019\_DEF.csv}
\CommentTok{\# note that these data do not have yet the environmental variables. We have to repeat the process including the pseudo{-}absences }
\CommentTok{\# because some dates were wrong in the previous file (anicho\_landings\_final\_FECHASMAL.csv)}

\NormalTok{data.dir }\OtherTok{\textless{}{-}} \FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{)}

\CommentTok{\# Data frame with environmental variables {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# read data{-}file}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(data.dir,}\StringTok{"df\_2010\_2019\_DEF.csv"}\NormalTok{), }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{";"}\NormalTok{, }\AttributeTok{dec=}\StringTok{","}\NormalTok{)}

\FunctionTok{dim}\NormalTok{(df) }\CommentTok{\# 26336 rows and 11 columns}
\FunctionTok{head}\NormalTok{(df)}
\FunctionTok{tail}\NormalTok{(df)}
\FunctionTok{summary}\NormalTok{(df)}

\CommentTok{\# change the names}

\FunctionTok{names}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CODEUEBUQUE"}\NormalTok{,}\StringTok{"FECHA\_CAPT"}\NormalTok{,}\StringTok{"DOY"}\NormalTok{,}\StringTok{"WEEK"}\NormalTok{,}\StringTok{"MONTH"}\NormalTok{,}\StringTok{"YEAR"}\NormalTok{,}\StringTok{"LAND"}\NormalTok{,}\StringTok{"OK"}\NormalTok{,}\StringTok{"PESO\_ANE"}\NormalTok{,}\StringTok{"LAT"}\NormalTok{,}\StringTok{"LON"}\NormalTok{)}
  
\CommentTok{\# format}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT, }\AttributeTok{format=}\StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)}

\CommentTok{\# check duplicates in all the columns}

\NormalTok{dupli }\OtherTok{\textless{}{-}} \FunctionTok{duplicated}\NormalTok{(df)}
\FunctionTok{table}\NormalTok{(dupli) }\CommentTok{\# there are 13 duplicated rows!!}
\NormalTok{df[dupli, ] }\CommentTok{\# this shows only the rows that are duplicated (ie the second/third/... time they appear)}

\NormalTok{dupli }\OtherTok{\textless{}{-}} \FunctionTok{duplicated}\NormalTok{(df) }\SpecialCharTok{|} \FunctionTok{duplicated}\NormalTok{(df, }\AttributeTok{fromLast=}\NormalTok{T) }\CommentTok{\# to see the duplicates and the first time they appear}
\FunctionTok{table}\NormalTok{(dupli) }\CommentTok{\# 26, ie each duplicated row appears twice }
\NormalTok{df[dupli, ]}

\CommentTok{\# LIC: tras hablar con Lucia parece que aunque parezcan replicados, son datos oficiales de SGPM y}
\CommentTok{\# tendrian que ser correctos. Asi que los agrupo y sumo la variable PESO}

\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{group\_by\_at}\NormalTok{(}\FunctionTok{vars}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{PESO\_ANE)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{PESO\_ANE=}\FunctionTok{sum}\NormalTok{(PESO\_ANE)) }
\FunctionTok{dim}\NormalTok{(df) }\CommentTok{\# 26085 observations}

\CommentTok{\# select only points from March to July}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df, MONTH }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\SpecialCharTok{:}\DecValTok{7}\NormalTok{)) }\CommentTok{\# 25036 observations}
\FunctionTok{dim}\NormalTok{(df) }\CommentTok{\# 25036 observations}

\CommentTok{\# Depth, ICES statistical rectangles etc {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}


\CommentTok{\# read shapefile with ices divisions}

\NormalTok{ices.areas.shp }\OtherTok{\textless{}{-}} \FunctionTok{st\_read}\NormalTok{(}\StringTok{"C:/use/proyectos/IM{-}18{-}ANICHO/datos/ICES\_shapefiles/ICES\_areas"}\NormalTok{)}
\FunctionTok{st\_crs}\NormalTok{(ices.areas.shp)}
\NormalTok{wgs}\OtherTok{\textless{}{-}}\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}
\NormalTok{ices.areas.shp }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(ices.areas.shp, wgs) }

\NormalTok{ices.rect.shp }\OtherTok{\textless{}{-}} \FunctionTok{st\_read}\NormalTok{(}\StringTok{"C:/use/proyectos/IM{-}18{-}ANICHO/datos/ICES\_shapefiles/ICES\_rectangles"}\NormalTok{)}
\FunctionTok{st\_crs}\NormalTok{(ices.rect.shp)}
\NormalTok{wgs}\OtherTok{\textless{}{-}}\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}
\NormalTok{ices.rect.shp }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(ices.rect.shp, wgs)}

\NormalTok{ices.rectareas.shp }\OtherTok{\textless{}{-}} \FunctionTok{st\_read}\NormalTok{(}\StringTok{"C:/use/proyectos/IM{-}18{-}ANICHO/datos/ICES\_shapefiles/ICES\_StatRec\_mapto\_ICES\_Areas"}\NormalTok{)}
\FunctionTok{st\_crs}\NormalTok{(ices.rectareas.shp)}
\NormalTok{wgs}\OtherTok{\textless{}{-}}\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}
\NormalTok{ices.rectareas.shp }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(ices.rectareas.shp, wgs)}

\CommentTok{\# get bathymetry data}

\NormalTok{bathy }\OtherTok{\textless{}{-}} \FunctionTok{getNOAA.bathy}\NormalTok{(}\AttributeTok{lon1=}\SpecialCharTok{{-}}\DecValTok{18}\NormalTok{,}\AttributeTok{lon2=}\DecValTok{0}\NormalTok{,}\AttributeTok{lat1=}\DecValTok{41}\NormalTok{,}\AttributeTok{lat2=}\DecValTok{51}\NormalTok{, }\AttributeTok{resolution =} \DecValTok{1}\NormalTok{, }
                       \AttributeTok{keep=}\ConstantTok{FALSE}\NormalTok{, }\AttributeTok{antimeridian=}\ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{class}\NormalTok{(bathy)}
\FunctionTok{autoplot}\NormalTok{(bathy)}
\NormalTok{bathy.df }\OtherTok{\textless{}{-}} \FunctionTok{fortify}\NormalTok{(bathy)}
\FunctionTok{class}\NormalTok{(bathy.df)}
\FunctionTok{str}\NormalTok{(bathy.df)}

\CommentTok{\# add Depth from marmap according to Lon and Lat}

\NormalTok{idx }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{LON) }\SpecialCharTok{\&} \SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{LAT) }\SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{LON }\SpecialCharTok{\textgreater{}} \SpecialCharTok{{-}}\DecValTok{18} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{LON }\SpecialCharTok{\textless{}} \DecValTok{0} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{LAT }\SpecialCharTok{\textgreater{}}\DecValTok{41} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{LAT }\SpecialCharTok{\textless{}} \DecValTok{51}\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{DEPTH }\OtherTok{\textless{}{-}} \ConstantTok{NA}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{DEPTH[idx] }\OtherTok{\textless{}{-}} \FunctionTok{get.depth}\NormalTok{(bathy, df[idx,}\FunctionTok{c}\NormalTok{(}\StringTok{"LON"}\NormalTok{,}\StringTok{"LAT"}\NormalTok{)], }\AttributeTok{locator=}\NormalTok{F)}\SpecialCharTok{$}\NormalTok{depth}

\CommentTok{\# Maps {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# basic map data}

\NormalTok{global }\OtherTok{\textless{}{-}} \FunctionTok{map\_data}\NormalTok{(}\StringTok{"worldHires"}\NormalTok{)}

\CommentTok{\# basic ggplot}

\NormalTok{p0 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_contour}\NormalTok{(}\AttributeTok{data=}\NormalTok{bathy.df, }\FunctionTok{aes}\NormalTok{(x,y,}\AttributeTok{z=}\NormalTok{z), }\AttributeTok{breaks=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{200}\NormalTok{), }\AttributeTok{col=}\StringTok{"grey"}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{annotation\_map}\NormalTok{(}\AttributeTok{map=}\NormalTok{global, }\AttributeTok{fill=}\StringTok{"grey"}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\FunctionTok{fortify}\NormalTok{(ices.areas.shp[}\DecValTok{1}\NormalTok{]), }\AttributeTok{fill=}\ConstantTok{NA}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{minor\_breaks =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{))}\SpecialCharTok{+}   \CommentTok{\# ices rectangles}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{minor\_breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{42}\NormalTok{, }\DecValTok{50}\NormalTok{, }\FloatTok{0.5}\NormalTok{), }\AttributeTok{breaks=}\FunctionTok{seq}\NormalTok{(}\DecValTok{42}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{1}\NormalTok{))}\SpecialCharTok{+}   \CommentTok{\# ices rectangles}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{42}\NormalTok{,}\DecValTok{50}\NormalTok{))}\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{)}
\FunctionTok{print}\NormalTok{(p0)}

\CommentTok{\# EGSP: Transformation to UTM {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# function to find your UTM. Taken from Nerea Goikoetxea}

\NormalTok{lonlat2UTM }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(lonlat) \{}
\NormalTok{  utm }\OtherTok{=}\NormalTok{ (}\FunctionTok{floor}\NormalTok{((lonlat[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \DecValTok{180}\NormalTok{) }\SpecialCharTok{/} \DecValTok{6}\NormalTok{) }\SpecialCharTok{\%\%} \DecValTok{60}\NormalTok{) }\SpecialCharTok{+} \DecValTok{1}
  \ControlFlowTok{if}\NormalTok{(lonlat[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    utm }\SpecialCharTok{+} \DecValTok{32600}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{    utm }\SpecialCharTok{+} \DecValTok{32700}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{EPSG\_2\_UTM }\OtherTok{\textless{}{-}} \FunctionTok{lonlat2UTM}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{mean}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{LON), }\FunctionTok{mean}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{LAT))) }
\NormalTok{EPSG\_2\_UTM }\CommentTok{\# 32630 {-}{-}\textgreater{} UTM zone 30N; }
\CommentTok{\#           WGS84 Bounds: {-}6.0000, 0.0000, 0.0000, 84.0000}
\CommentTok{\#           Projected Bounds: 166021.4431, 0.0000, 833978.5569, 9329005.1825}

\CommentTok{\# Visualize areas for generating pseudo{-}absences {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# check class}
\FunctionTok{class}\NormalTok{(ices.rectareas.shp)}

\CommentTok{\# select multipolygon object from the shapefile}
\NormalTok{aux1 }\OtherTok{\textless{}{-}}\NormalTok{ ices.areas.shp[ices.areas.shp}\SpecialCharTok{$}\NormalTok{Area\_27 }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"8.b"}\NormalTok{, }\StringTok{"8.c"}\NormalTok{), ]}

\CommentTok{\# create a polygon for intersection with ices areas, so that we can select from 6ÂºW to the east}

\NormalTok{aux2 }\OtherTok{\textless{}{-}} \FunctionTok{st\_sfc}\NormalTok{(}\FunctionTok{st\_polygon}\NormalTok{( }\FunctionTok{list}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\DecValTok{40}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{40}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\DecValTok{40}\NormalTok{)))))}
\NormalTok{aux2 }\OtherTok{\textless{}{-}} \FunctionTok{st\_set\_crs}\NormalTok{(aux2, }\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}\NormalTok{) }
\NormalTok{wgs}\OtherTok{\textless{}{-}}\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}
\NormalTok{aux2 }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(aux2, wgs) }

\CommentTok{\# create a polygon for union with ices areas, so that we can add two rectangles from 4ÂºW to the east}

\NormalTok{aux3 }\OtherTok{\textless{}{-}} \FunctionTok{st\_sfc}\NormalTok{(}\FunctionTok{st\_polygon}\NormalTok{( }\FunctionTok{list}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{44}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{46}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\DecValTok{46}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{,}\DecValTok{44}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{44}\NormalTok{)))))}
\CommentTok{\# aux3 \textless{}{-} st\_sfc(st\_polygon( list(rbind(c({-}4, 44.5), c({-}4, 45.5), c({-}2, 45.5), c({-}2,44.5), c({-}4, 44.5)))))}
\NormalTok{aux3 }\OtherTok{\textless{}{-}} \FunctionTok{st\_set\_crs}\NormalTok{(aux3, }\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}\NormalTok{) }
\NormalTok{wgs}\OtherTok{\textless{}{-}}\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}
\NormalTok{aux3 }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(aux3, wgs) }

\CommentTok{\# transform the catch data points into sf and add the CRS}

\NormalTok{df.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_as\_sf}\NormalTok{(df, }\AttributeTok{coords=}\FunctionTok{c}\NormalTok{(}\StringTok{"LON"}\NormalTok{,}\StringTok{"LAT"}\NormalTok{))}
\NormalTok{df.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_set\_crs}\NormalTok{(df.sf, }\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}\NormalTok{) }
\NormalTok{wgs}\OtherTok{\textless{}{-}}\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}
\NormalTok{df.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(df.sf, wgs) }

\CommentTok{\# transform to UTMs (in m)}

\NormalTok{aux1.utm }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(aux1, EPSG\_2\_UTM)}
\NormalTok{aux2.utm }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(aux2, EPSG\_2\_UTM)}
\NormalTok{aux3.utm }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(aux3, EPSG\_2\_UTM)}
\NormalTok{df.sf.utm }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(df.sf, EPSG\_2\_UTM)}

\CommentTok{\# convex hull of presence data}
\CommentTok{\# df\_buff \textless{}{-} st\_convex\_hull(st\_union(df.sf.utm))}
\CommentTok{\# plot(df\_buff)}

\CommentTok{\# create buffers of 10km (10000) around the points and join the resulting polygons}

\NormalTok{buffer }\OtherTok{\textless{}{-}} \FunctionTok{st\_buffer}\NormalTok{(df.sf.utm, }\AttributeTok{dist=}\DecValTok{10000}\NormalTok{)}
\NormalTok{buffer }\OtherTok{\textless{}{-}} \FunctionTok{st\_union}\NormalTok{(buffer)}
\FunctionTok{plot}\NormalTok{(buffer)}

\CommentTok{\# intersect the ices divisions and the squares}

\NormalTok{aux }\OtherTok{\textless{}{-}} \FunctionTok{st\_intersection}\NormalTok{(}\AttributeTok{x=}\FunctionTok{st\_union}\NormalTok{(}\FunctionTok{st\_union}\NormalTok{(aux1.utm), aux3.utm), }\AttributeTok{y=}\NormalTok{aux2.utm)}
\FunctionTok{plot}\NormalTok{(aux, }\AttributeTok{col=}\DecValTok{2}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(buffer, }\AttributeTok{add=}\NormalTok{T)}

\CommentTok{\# intersect the result with the buffers around the catch data points}
\NormalTok{aux0 }\OtherTok{\textless{}{-}} \FunctionTok{st\_difference}\NormalTok{(aux, buffer)}
\FunctionTok{plot}\NormalTok{(aux0, }\AttributeTok{col=}\DecValTok{2}\NormalTok{)}

\CommentTok{\# ggplot for all data}

\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{aux0, }\AttributeTok{fill=}\StringTok{"red"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{42}\NormalTok{,}\DecValTok{50}\NormalTok{))}
\FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\FunctionTok{paste0}\NormalTok{(}\StringTok{"area\_pseudo\_all.png"}\NormalTok{)), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}

\CommentTok{\# \# randomly sample inside the new polygon}
\CommentTok{\# }
\CommentTok{\# kk \textless{}{-}  st\_sample(aux0, size=100, type="random")}
\CommentTok{\# }
\CommentTok{\# \# plot}
\CommentTok{\# }
\CommentTok{\# p \textless{}{-} p0 +}
\CommentTok{\#   geom\_sf(data=aux0, col="red", alpha=0.3)+}
\CommentTok{\#   geom\_sf(data=fortify(kk))+}
\CommentTok{\#   coord\_sf(xlim=c({-}10,0), ylim=c(42,50))}
\CommentTok{\# print(p)}
\CommentTok{\# }
\CommentTok{\# \# extract coordinates as data.frame}
\CommentTok{\# }
\CommentTok{\# st\_coordinates(kk)}

\CommentTok{\# loop to calculate area to generate pseudo{-}absences by year}

\ControlFlowTok{for}\NormalTok{ (yy }\ControlFlowTok{in} \FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{YEAR)))\{}
\NormalTok{  df.sub }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df.sf.utm, YEAR}\SpecialCharTok{==}\NormalTok{yy)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(df.sub)}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)\{}
\NormalTok{    buffer.sub }\OtherTok{\textless{}{-}} \FunctionTok{st\_buffer}\NormalTok{(df.sub, }\AttributeTok{dist=}\DecValTok{10000}\NormalTok{)}
\NormalTok{    buffer.sub }\OtherTok{\textless{}{-}} \FunctionTok{st\_union}\NormalTok{(buffer.sub)}
\NormalTok{    aux0.sub }\OtherTok{\textless{}{-}} \FunctionTok{st\_difference}\NormalTok{(aux, buffer.sub)}
\NormalTok{    p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
      \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{aux0.sub, }\AttributeTok{fill=}\StringTok{"red"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
      \CommentTok{\#geom\_sf(data=df.sub)+}
      \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{43}\NormalTok{,}\DecValTok{46}\NormalTok{))}
    \FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\FunctionTok{paste0}\NormalTok{(}\StringTok{"area\_pseudo\_"}\NormalTok{,yy,}\StringTok{".png"}\NormalTok{)), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}

\CommentTok{\# loop to calculate area to generate pseudo{-}absences by month and year}

\ControlFlowTok{for}\NormalTok{ (yy }\ControlFlowTok{in} \FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{YEAR)))\{}
  \ControlFlowTok{for}\NormalTok{ (mm }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{7}\NormalTok{,}\AttributeTok{by=}\DecValTok{1}\NormalTok{))\{}
\NormalTok{    df.sub }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df.sf.utm, YEAR}\SpecialCharTok{==}\NormalTok{yy }\SpecialCharTok{\&}\NormalTok{ MONTH}\SpecialCharTok{==}\NormalTok{mm)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(df.sub)}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)\{}
\NormalTok{      buffer.sub }\OtherTok{\textless{}{-}} \FunctionTok{st\_buffer}\NormalTok{(df.sub, }\AttributeTok{dist=}\DecValTok{10000}\NormalTok{)}
\NormalTok{      buffer.sub }\OtherTok{\textless{}{-}} \FunctionTok{st\_union}\NormalTok{(buffer.sub)}
\NormalTok{      aux0.sub }\OtherTok{\textless{}{-}} \FunctionTok{st\_difference}\NormalTok{(aux, buffer.sub)}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
        \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{aux0.sub, }\AttributeTok{fill=}\StringTok{"red"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
        \CommentTok{\#geom\_sf(data=df.sub)+}
        \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{43}\NormalTok{,}\DecValTok{46}\NormalTok{))}
      \FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\FunctionTok{paste0}\NormalTok{(}\StringTok{"area\_pseudo\_"}\NormalTok{,yy,}\StringTok{"\_"}\NormalTok{,mm,}\StringTok{".png"}\NormalTok{)), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}
\NormalTok{    \}    }
\NormalTok{  \}}
\NormalTok{\}}

\CommentTok{\# Remove points outside ices 8b, 8c or in land {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# number of points within the study area}

\NormalTok{df.in }\OtherTok{\textless{}{-}} \FunctionTok{st\_intersects}\NormalTok{(df.sf.utm, aux, }\AttributeTok{sparse=}\ConstantTok{FALSE}\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{INSIDE }\OtherTok{\textless{}{-}}\NormalTok{ df.in[,}\DecValTok{1}\NormalTok{]}
\FunctionTok{mean}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{INSIDE) }\CommentTok{\# 0.9743969 points inside the area of study}

\FunctionTok{table}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{INSIDE)}
\FunctionTok{table}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{DEPTH}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)}
\FunctionTok{table}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{INSIDE, df}\SpecialCharTok{$}\NormalTok{DEPTH}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data=}\FunctionTok{subset}\NormalTok{(df, INSIDE}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ DEPTH }\SpecialCharTok{\textless{}=}\DecValTok{0}\NormalTok{), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{LON, }\AttributeTok{y=}\NormalTok{LAT), }\AttributeTok{col=}\StringTok{"red"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{43}\NormalTok{,}\DecValTok{46}\NormalTok{))}\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Points inside area with Depth\textless{}=0"}\NormalTok{)}
  \FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\FunctionTok{paste0}\NormalTok{(}\StringTok{"points\_inside\_depthneg.png"}\NormalTok{)), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data=}\FunctionTok{subset}\NormalTok{(df, INSIDE}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ DEPTH }\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{LON, }\AttributeTok{y=}\NormalTok{LAT), }\AttributeTok{col=}\StringTok{"red"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{43}\NormalTok{,}\DecValTok{46}\NormalTok{))}\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Points inside area with Depth\textgreater{}0"}\NormalTok{)}
  \FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\FunctionTok{paste0}\NormalTok{(}\StringTok{"points\_inside\_depthpos.png"}\NormalTok{)), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data=}\FunctionTok{subset}\NormalTok{(df, INSIDE}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ DEPTH }\SpecialCharTok{\textless{}=} \DecValTok{0}\NormalTok{), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{LON, }\AttributeTok{y=}\NormalTok{LAT), }\AttributeTok{col=}\StringTok{"red"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{43}\NormalTok{,}\DecValTok{46}\NormalTok{))}\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Points outside area with Depth\textless{}=0"}\NormalTok{)}
  \FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\FunctionTok{paste0}\NormalTok{(}\StringTok{"points\_outside\_depthneg.png"}\NormalTok{)), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data=}\FunctionTok{subset}\NormalTok{(df, INSIDE}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ DEPTH }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{LON, }\AttributeTok{y=}\NormalTok{LAT), }\AttributeTok{col=}\StringTok{"red"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{43}\NormalTok{,}\DecValTok{46}\NormalTok{))}\SpecialCharTok{+}
\CommentTok{\#  coord\_sf(xlim=c({-}10,0), ylim=c(42,50))+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Points outside area with Depth\textgreater{}0"}\NormalTok{)}
  \FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\FunctionTok{paste0}\NormalTok{(}\StringTok{"points\_outside\_depthpos.png"}\NormalTok{)), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}

\CommentTok{\# So, we keep only the points INSIDE the area with DEPTH\textless{}0}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df, INSIDE}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ DEPTH }\SpecialCharTok{\textless{}=} \DecValTok{0}\NormalTok{)}
\FunctionTok{dim}\NormalTok{(df) }\CommentTok{\# 24147 observations}

\CommentTok{\# remove the columns that are not going to be used}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{LAND }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{OK }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{INSIDE }\OtherTok{\textless{}{-}} \ConstantTok{NULL}

\CommentTok{\# Generate pseudo{-}absences {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# we will use the positive database to generate the pseudo{-}absences}

\NormalTok{dfpos }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df, PESO\_ANE}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)}
\NormalTok{nbpoints }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(dfpos) }\CommentTok{\# 23678 out of 24147 are positive observations (98\%)}

\CommentTok{\# we compute again the buffer but only for the positive data points}

\CommentTok{\# transform the catch data points into sf and add the CRS}

\NormalTok{dfpos.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_as\_sf}\NormalTok{(dfpos, }\AttributeTok{coords=}\FunctionTok{c}\NormalTok{(}\StringTok{"LON"}\NormalTok{,}\StringTok{"LAT"}\NormalTok{))}
\NormalTok{dfpos.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_set\_crs}\NormalTok{(dfpos.sf, }\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}\NormalTok{) }
\NormalTok{wgs}\OtherTok{\textless{}{-}}\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}
\NormalTok{dfpos.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(dfpos.sf, wgs) }
\NormalTok{dfpos.sf.utm }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(dfpos.sf, EPSG\_2\_UTM) }\CommentTok{\# transform to UTMs (in m)}

\CommentTok{\# Generate the pseudo{-}absence data frame}

\NormalTok{pseudo }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\AttributeTok{data=}\ConstantTok{NA}\NormalTok{, }\AttributeTok{nrow=}\NormalTok{nbpoints, }\AttributeTok{ncol=}\DecValTok{10}\NormalTok{)}
\NormalTok{pseudo }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(pseudo)}
\FunctionTok{names}\NormalTok{(pseudo) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CODEUEBUQUE"}\NormalTok{,}\StringTok{"FECHA\_CAPT"}\NormalTok{,}\StringTok{"DOY"}\NormalTok{,}\StringTok{"WEEK"}\NormalTok{,}\StringTok{"MONTH"}\NormalTok{,}\StringTok{"YEAR"}\NormalTok{,}\StringTok{"LAT"}\NormalTok{,}\StringTok{"LON"}\NormalTok{,}\StringTok{"PESO\_ANE"}\NormalTok{,}\StringTok{"DEPTH"}\NormalTok{)}

\CommentTok{\# set the seed}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1}\NormalTok{)}

\CommentTok{\# sample the date}

\NormalTok{pseudo}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\AttributeTok{x=}\NormalTok{dfpos}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT, }\AttributeTok{size=}\NormalTok{nbpoints, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{pseudo}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT }\OtherTok{\textless{}{-}} \FunctionTok{as.Date}\NormalTok{(pseudo}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT, }\AttributeTok{format=}\StringTok{"\%Y{-}\%m{-}\%d"}\NormalTok{)}
\NormalTok{pseudo}\SpecialCharTok{$}\NormalTok{DOY }\OtherTok{\textless{}{-}} \FunctionTok{yday}\NormalTok{(pseudo}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT)}
\NormalTok{pseudo}\SpecialCharTok{$}\NormalTok{WEEK }\OtherTok{\textless{}{-}} \FunctionTok{week}\NormalTok{(pseudo}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT)}
\NormalTok{pseudo}\SpecialCharTok{$}\NormalTok{MONTH }\OtherTok{\textless{}{-}} \FunctionTok{month}\NormalTok{(pseudo}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT)}
\NormalTok{pseudo}\SpecialCharTok{$}\NormalTok{YEAR }\OtherTok{\textless{}{-}} \FunctionTok{year}\NormalTok{(pseudo}\SpecialCharTok{$}\NormalTok{FECHA\_CAPT)}

\CommentTok{\# loop by month and year}

\ControlFlowTok{for}\NormalTok{ (yy }\ControlFlowTok{in} \FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(dfpos}\SpecialCharTok{$}\NormalTok{YEAR)))\{}
  \ControlFlowTok{for}\NormalTok{ (mm }\ControlFlowTok{in} \FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(dfpos}\SpecialCharTok{$}\NormalTok{MONTH)))\{}
\NormalTok{    idx }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(pseudo}\SpecialCharTok{$}\NormalTok{YEAR}\SpecialCharTok{==}\NormalTok{yy }\SpecialCharTok{\&}\NormalTok{ pseudo}\SpecialCharTok{$}\NormalTok{MONTH}\SpecialCharTok{==}\NormalTok{mm) }
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(idx)}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)\{}
\NormalTok{      df.sub }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(dfpos.sf.utm, YEAR}\SpecialCharTok{==}\NormalTok{yy }\SpecialCharTok{\&}\NormalTok{ MONTH}\SpecialCharTok{==}\NormalTok{mm)}
\NormalTok{      buffer.sub }\OtherTok{\textless{}{-}} \FunctionTok{st\_buffer}\NormalTok{(df.sub, }\AttributeTok{dist=}\DecValTok{10000}\NormalTok{)}
\NormalTok{      buffer.sub }\OtherTok{\textless{}{-}} \FunctionTok{st\_union}\NormalTok{(buffer.sub)}
\NormalTok{      aux0.sub }\OtherTok{\textless{}{-}} \FunctionTok{st\_difference}\NormalTok{(aux, buffer.sub)}
\NormalTok{      rp.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_sample}\NormalTok{(aux0.sub, }\AttributeTok{size=}\FunctionTok{length}\NormalTok{(idx), }\AttributeTok{type=}\StringTok{"random"}\NormalTok{) }\CommentTok{\# randomly sample points}
\NormalTok{      rp.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(rp.sf, }\DecValTok{4326}\NormalTok{)}
\NormalTok{      rp }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{st\_coordinates}\NormalTok{(rp.sf)) }\CommentTok{\# transform to lat\&lon and extract coordinates as data.frame}
\NormalTok{      pseudo}\SpecialCharTok{$}\NormalTok{LON[idx] }\OtherTok{\textless{}{-}}\NormalTok{ rp}\SpecialCharTok{$}\NormalTok{X}
\NormalTok{      pseudo}\SpecialCharTok{$}\NormalTok{LAT[idx] }\OtherTok{\textless{}{-}}\NormalTok{ rp}\SpecialCharTok{$}\NormalTok{Y}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
        \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{aux0.sub, }\AttributeTok{fill=}\DecValTok{2}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
        \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{df.sub, }\AttributeTok{col=}\DecValTok{4}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
        \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{rp.sf, }\AttributeTok{col=}\DecValTok{1}\NormalTok{, }\AttributeTok{shape=}\DecValTok{4}\NormalTok{)}\SpecialCharTok{+}
        \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{43}\NormalTok{,}\DecValTok{46}\NormalTok{))}\SpecialCharTok{+}
        \FunctionTok{ggtitle}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"ANE"}\NormalTok{,yy,mm)) }
      \FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\FunctionTok{paste0}\NormalTok{(}\StringTok{"pseudo\_"}\NormalTok{,yy,}\StringTok{"\_"}\NormalTok{,mm,}\StringTok{".png"}\NormalTok{)), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}
\NormalTok{    \}  }
\NormalTok{  \}}
\NormalTok{\}}


\CommentTok{\# complete the rest of columns}

\NormalTok{pseudo}\SpecialCharTok{$}\NormalTok{CODEUEBUQUE }\OtherTok{\textless{}{-}} \StringTok{"ESPxxxxxxxxx"} \CommentTok{\# generic name to distinguish the pseudo{-}absence data}
\NormalTok{pseudo}\SpecialCharTok{$}\NormalTok{PESO\_ANE }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{pseudo}\SpecialCharTok{$}\NormalTok{DEPTH }\OtherTok{\textless{}{-}} \FunctionTok{get.depth}\NormalTok{(bathy, pseudo[ ,}\FunctionTok{c}\NormalTok{(}\StringTok{"LON"}\NormalTok{,}\StringTok{"LAT"}\NormalTok{)], }\AttributeTok{locator=}\NormalTok{F)}\SpecialCharTok{$}\NormalTok{depth}

\CommentTok{\# there might be still some locations with Depth\textgreater{}0 }
\FunctionTok{summary}\NormalTok{(pseudo}\SpecialCharTok{$}\NormalTok{DEPTH)}
\FunctionTok{sum}\NormalTok{(pseudo}\SpecialCharTok{$}\NormalTok{DEPTH}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)  }\CommentTok{\# 197 obs}
\FunctionTok{mean}\NormalTok{(pseudo}\SpecialCharTok{$}\NormalTok{DEPTH}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{) }\CommentTok{\# 0.008316447 very small proportion}

\CommentTok{\# transform to sf object (lat\&lon) to plot}

\NormalTok{pseudo.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_as\_sf}\NormalTok{(pseudo, }\AttributeTok{coords=}\FunctionTok{c}\NormalTok{(}\StringTok{"LON"}\NormalTok{,}\StringTok{"LAT"}\NormalTok{))}
\NormalTok{pseudo.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_set\_crs}\NormalTok{(pseudo.sf, }\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}\NormalTok{) }
\NormalTok{wgs}\OtherTok{\textless{}{-}}\StringTok{"+proj=longlat +datum=WGS84 +ellps=WGS84"}
\NormalTok{pseudo.sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(pseudo.sf, wgs) }

\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{pseudo.sf, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{col=}\NormalTok{(DEPTH}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)), }\AttributeTok{col=}\StringTok{"red"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{42}\NormalTok{,}\DecValTok{46}\NormalTok{))}
  \CommentTok{\#  coord\_sf(xlim=c({-}10,0), ylim=c(42,50))+}
\FunctionTok{print}\NormalTok{(p)}

\CommentTok{\# plot all pseudo{-}absences}

\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{aux0, }\AttributeTok{fill=}\DecValTok{2}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{dfpos.sf, }\AttributeTok{col=}\DecValTok{4}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{pseudo.sf, }\AttributeTok{col=}\DecValTok{1}\NormalTok{, }\AttributeTok{shape=}\DecValTok{4}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{43}\NormalTok{,}\DecValTok{46}\NormalTok{))}
\FunctionTok{print}\NormalTok{(p)}
\FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\StringTok{"pseudo\_all.png"}\NormalTok{), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}

\CommentTok{\# plot pseudo{-}absences by year}

\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ p0 }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{aux0, }\AttributeTok{fill=}\DecValTok{2}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{dfpos.sf, }\AttributeTok{col=}\DecValTok{4}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data=}\NormalTok{pseudo.sf, }\AttributeTok{col=}\DecValTok{1}\NormalTok{, }\AttributeTok{shape=}\DecValTok{4}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{43}\NormalTok{,}\DecValTok{46}\NormalTok{))}\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{YEAR)}
\FunctionTok{print}\NormalTok{(p)}
\FunctionTok{ggsave}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"plots"}\NormalTok{,}\StringTok{"pseudo"}\NormalTok{,}\StringTok{"pseudo\_all\_by\_year.png"}\NormalTok{), p, }\AttributeTok{device=}\StringTok{"png"}\NormalTok{)}


\CommentTok{\# Save the final dataset including the pseudo{-}absences {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\FunctionTok{head}\NormalTok{(df)}
\FunctionTok{head}\NormalTok{(pseudo)}

\CommentTok{\# Join the two data sets and save the final dataset}

\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(df, pseudo)}
\FunctionTok{write.table}\NormalTok{(dat, }\AttributeTok{file=}\FunctionTok{file.path}\NormalTok{(}\StringTok{"data"}\NormalTok{,}\StringTok{"dfpseudo\_ane\_2010\_2019.csv"}\NormalTok{), }\AttributeTok{row.names=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{";"}\NormalTok{, }\AttributeTok{dec=}\StringTok{"."}\NormalTok{)}

\CommentTok{\# End of script {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\hypertarget{environmental-data}{%
\chapter{Environmental data}\label{environmental-data}}

Bla bla bla

\hypertarget{download-from-public-repositories}{%
\section{Download from public repositories}\label{download-from-public-repositories}}

Download from Bio-oracle.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# Download Environmental data from Bio{-}oracle}

\CommentTok{\# for mapping ...}
\FunctionTok{library}\NormalTok{(maptools)}
\FunctionTok{library}\NormalTok{(rgrass7)}
\FunctionTok{library}\NormalTok{(raster)}
\FunctionTok{library}\NormalTok{(sp)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(maps)}

\CommentTok{\# libraries for bio{-}oracle}
\FunctionTok{library}\NormalTok{(rgdal)}
\FunctionTok{library}\NormalTok{(sdmpredictors) }
\FunctionTok{library}\NormalTok{(leaflet)}

\CommentTok{\# http://bio{-}oracle.org/code.php}
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"sdmpredictors"}\NormalTok{)}
\CommentTok{\#install.packages("leaflet")}

\CommentTok{\# Load package }
\FunctionTok{library}\NormalTok{(sdmpredictors)}

\CommentTok{\# Species Data example from GBIF}
\NormalTok{mydata }\OtherTok{\textless{}{-}} \FunctionTok{occ\_data}\NormalTok{(}\AttributeTok{scientificName =} \StringTok{"Anisakis"}\NormalTok{, }\AttributeTok{hasCoordinate =} \ConstantTok{TRUE}\NormalTok{)}\SpecialCharTok{$}\NormalTok{data  }\CommentTok{\# 02/10/2021 416 obs x 150 var}
\NormalTok{mydata.gbif }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(mydata, }\AttributeTok{select=}\FunctionTok{c}\NormalTok{(acceptedScientificName,genus,specificEpithet,decimalLatitude,decimalLongitude,year,month,day))}
\NormalTok{mydata.gbif.ll }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(mydata.gbif}\SpecialCharTok{$}\NormalTok{decimalLongitude, mydata.gbif}\SpecialCharTok{$}\NormalTok{decimalLatitude)}
\NormalTok{mydata.gbif.ll }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(mydata.gbif.ll)}
\FunctionTok{names}\NormalTok{(mydata.gbif.ll) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Lon"}\NormalTok{, }\StringTok{"Lat"}\NormalTok{)}

\CommentTok{\# Explore datasets in the package }
\FunctionTok{list\_datasets}\NormalTok{()}
\FunctionTok{list\_layers}\NormalTok{(}\StringTok{"Bio{-}ORACLE"}\NormalTok{)}
\NormalTok{mytab }\OtherTok{\textless{}{-}} \FunctionTok{list\_layers}\NormalTok{(}\StringTok{"Bio{-}ORACLE"}\NormalTok{)}

\DocumentationTok{\#\# Download specific layers to the current directory }

\NormalTok{myBioracle.layers }\OtherTok{\textless{}{-}} \FunctionTok{load\_layers}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"BO\_chlomean"}\NormalTok{, }\StringTok{"BO\_damean"}\NormalTok{, }\StringTok{"BO\_salinity"}\NormalTok{, }\StringTok{"BO\_sstmean"}\NormalTok{, }\StringTok{"BO\_sstrange"}\NormalTok{, }\StringTok{"BO\_bathymean"}\NormalTok{)) }
\CommentTok{\#save(myBioracle.layers, file="myBioracle.layers.Rdata")}
\CommentTok{\#load(file="myBioracle.layers.Rdata") \# creo que no funciona}
\NormalTok{myBioracle.layers}

\CommentTok{\# Check layer statistics }
\FunctionTok{layer\_stats}\NormalTok{(}\StringTok{"myBioracle.layers"}\NormalTok{) }

\CommentTok{\# Crop raster to fit the North East Atlantic window for estimating SST range}
\CommentTok{\# lat: 36.49 to 67.00  }
\CommentTok{\# lon: {-}16.000 to 9.000}
\NormalTok{my.NEatlantic.ext }\OtherTok{\textless{}{-}} \FunctionTok{extent}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{, }\DecValTok{45}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, }\DecValTok{90}\NormalTok{) }\CommentTok{\# xmin, xmax, ymin, ymax}
\NormalTok{myBioracle.layers.cropNEatlantic }\OtherTok{\textless{}{-}} \FunctionTok{crop}\NormalTok{(myBioracle.layers, my.NEatlantic.ext) }
\NormalTok{my.colors }\OtherTok{=} \FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"\#5E85B8"}\NormalTok{,}\StringTok{"\#EDF0C0"}\NormalTok{,}\StringTok{"\#C13127"}\NormalTok{)) }
\FunctionTok{plot}\NormalTok{(myBioracle.layers.cropNEatlantic,}\AttributeTok{col=}\FunctionTok{my.colors}\NormalTok{(}\DecValTok{1000}\NormalTok{),}\AttributeTok{axes=}\NormalTok{F, }\AttributeTok{box=}\NormalTok{F)}
\FunctionTok{summary}\NormalTok{(myBioracle.layers.cropNEatlantic)}

\CommentTok{\# Generate a nice color ramp and plot the map }
\NormalTok{my.colors }\OtherTok{=} \FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"\#5E85B8"}\NormalTok{,}\StringTok{"\#EDF0C0"}\NormalTok{,}\StringTok{"\#C13127"}\NormalTok{)) }

\FunctionTok{plot}\NormalTok{(myBioracle.layers.cropNEatlantic,}\AttributeTok{col=}\FunctionTok{my.colors}\NormalTok{(}\DecValTok{1000}\NormalTok{),}\AttributeTok{axes=}\NormalTok{F, }\AttributeTok{box=}\NormalTok{F)}

\FunctionTok{image}\NormalTok{(}\FunctionTok{log}\NormalTok{(myBioracle.layers.cropNEatlantic}\SpecialCharTok{$}\NormalTok{BO\_chlomean),}\AttributeTok{col=}\FunctionTok{my.colors}\NormalTok{(}\DecValTok{1000}\NormalTok{),}\AttributeTok{axes=}\NormalTok{T, }\AttributeTok{ylab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{xlab=}\ConstantTok{NA}\NormalTok{, }\AttributeTok{main=}\StringTok{"Chl (log scale)"}\NormalTok{, }\AttributeTok{cex.main=}\DecValTok{2}\NormalTok{)}
\FunctionTok{map}\NormalTok{(}\StringTok{"world"}\NormalTok{,}\AttributeTok{add=}\NormalTok{T, }\AttributeTok{fill=}\NormalTok{T, }\AttributeTok{col=}\StringTok{"white"}\NormalTok{,}\AttributeTok{lwd=}\FloatTok{0.1}\NormalTok{); }\FunctionTok{box}\NormalTok{()}

\FunctionTok{image}\NormalTok{(}\FunctionTok{log}\NormalTok{(myBioracle.layers.cropNEatlantic}\SpecialCharTok{$}\NormalTok{BO\_damean),}\AttributeTok{col=}\FunctionTok{my.colors}\NormalTok{(}\DecValTok{1000}\NormalTok{),}\AttributeTok{axes=}\NormalTok{T, }\AttributeTok{ylab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{xlab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{main=}\StringTok{"Diffuse Attenuation"}\NormalTok{, }\AttributeTok{cex.main=}\DecValTok{2}\NormalTok{)}
\FunctionTok{map}\NormalTok{(}\StringTok{"world"}\NormalTok{,}\AttributeTok{add=}\NormalTok{T, }\AttributeTok{fill=}\NormalTok{T, }\AttributeTok{col=}\StringTok{"white"}\NormalTok{,}\AttributeTok{lwd=}\FloatTok{0.1}\NormalTok{); }\FunctionTok{box}\NormalTok{()}

\FunctionTok{image}\NormalTok{(myBioracle.layers.cropNEatlantic}\SpecialCharTok{$}\NormalTok{BO\_salinity,}\AttributeTok{col=}\FunctionTok{my.colors}\NormalTok{(}\DecValTok{1000}\NormalTok{),}\AttributeTok{axes=}\NormalTok{T, }\AttributeTok{ylab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{xlab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{main=}\StringTok{"Salinity"}\NormalTok{, }\AttributeTok{cex.main=}\DecValTok{2}\NormalTok{)}
\FunctionTok{map}\NormalTok{(}\StringTok{"world"}\NormalTok{,}\AttributeTok{add=}\NormalTok{T, }\AttributeTok{fill=}\NormalTok{T, }\AttributeTok{col=}\StringTok{"white"}\NormalTok{,}\AttributeTok{lwd=}\FloatTok{0.1}\NormalTok{); }\FunctionTok{box}\NormalTok{()}

\FunctionTok{image}\NormalTok{(myBioracle.layers.cropNEatlantic}\SpecialCharTok{$}\NormalTok{BO\_sstmean,}\AttributeTok{col=}\FunctionTok{my.colors}\NormalTok{(}\DecValTok{1000}\NormalTok{),}\AttributeTok{axes=}\NormalTok{T, }\AttributeTok{ylab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{xlab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{main=}\StringTok{"SST mean"}\NormalTok{, }\AttributeTok{cex.main=}\DecValTok{2}\NormalTok{)}
\FunctionTok{map}\NormalTok{(}\StringTok{"world"}\NormalTok{,}\AttributeTok{add=}\NormalTok{T, }\AttributeTok{fill=}\NormalTok{T, }\AttributeTok{col=}\StringTok{"white"}\NormalTok{,}\AttributeTok{lwd=}\FloatTok{0.1}\NormalTok{); }\FunctionTok{box}\NormalTok{()}

\FunctionTok{image}\NormalTok{(myBioracle.layers.cropNEatlantic}\SpecialCharTok{$}\NormalTok{BO\_sstrange,}\AttributeTok{col=}\FunctionTok{my.colors}\NormalTok{(}\DecValTok{1000}\NormalTok{),}\AttributeTok{axes=}\NormalTok{T, }\AttributeTok{ylab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{xlab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{main=}\StringTok{"SST range"}\NormalTok{, }\AttributeTok{cex.main=}\DecValTok{2}\NormalTok{)}
\FunctionTok{map}\NormalTok{(}\StringTok{"world"}\NormalTok{,}\AttributeTok{add=}\NormalTok{T, }\AttributeTok{fill=}\NormalTok{T, }\AttributeTok{col=}\StringTok{"white"}\NormalTok{,}\AttributeTok{lwd=}\FloatTok{0.1}\NormalTok{); }\FunctionTok{box}\NormalTok{()}

\FunctionTok{image}\NormalTok{(myBioracle.layers.cropNEatlantic}\SpecialCharTok{$}\NormalTok{BO\_bathymean,}\AttributeTok{col=}\FunctionTok{my.colors}\NormalTok{(}\DecValTok{1000}\NormalTok{),}\AttributeTok{axes=}\NormalTok{T, }\AttributeTok{ylab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{xlab=}\ConstantTok{NA}\NormalTok{,}\AttributeTok{main=}\StringTok{"Depth"}\NormalTok{, }\AttributeTok{cex.main=}\DecValTok{2}\NormalTok{)}
\FunctionTok{map}\NormalTok{(}\StringTok{"world"}\NormalTok{,}\AttributeTok{add=}\NormalTok{T, }\AttributeTok{fill=}\NormalTok{T, }\AttributeTok{col=}\StringTok{"white"}\NormalTok{,}\AttributeTok{lwd=}\FloatTok{0.1}\NormalTok{); }\FunctionTok{box}\NormalTok{()}


\DocumentationTok{\#\#\# Extract environmental values from layers }

\NormalTok{mydata1.env }\OtherTok{\textless{}{-}}\NormalTok{ raster}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(}\AttributeTok{x=}\NormalTok{myBioracle.layers,}\AttributeTok{y=}\NormalTok{mydata.gbif.ll, }\AttributeTok{df=}\NormalTok{T) }\CommentTok{\# sin buffer (se extrae solo los puntos)}

\CommentTok{\# con Bilinear extraigo los sites de los 4 nearest cells }
\NormalTok{mydata1.env.bil }\OtherTok{\textless{}{-}}\NormalTok{ raster}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(}\AttributeTok{x=}\NormalTok{myBioracle.layers,}\AttributeTok{y=}\NormalTok{mydata.gbif.ll, }\AttributeTok{method=}\StringTok{"bilinear"}\NormalTok{, }\AttributeTok{na.rm=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{df=}\NormalTok{T) }\CommentTok{\# 4 nearest cells, se consigue valor 29 sites más (se siguen perdiendo 64, de los cuales algunos son errores, es decir, no costeros)}

\NormalTok{mydata.all }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(mydata.gbif.ll, mydata1.env.bil)}

\FunctionTok{summary}\NormalTok{(mydata.all) }\CommentTok{\# 448 sites : 84 are NAs}
\end{Highlighting}
\end{Shaded}

We can also download the bathymetry from the \texttt{marmap} library

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(marmap)}

\NormalTok{bathy }\OtherTok{\textless{}{-}} \FunctionTok{getNOAA.bathy}\NormalTok{(}\AttributeTok{lon1=}\SpecialCharTok{{-}}\DecValTok{11}\NormalTok{,}\AttributeTok{lon2=}\DecValTok{0}\NormalTok{,}\AttributeTok{lat1=}\DecValTok{41}\NormalTok{,}\AttributeTok{lat2=}\DecValTok{51}\NormalTok{, }\AttributeTok{resolution =} \DecValTok{1}\NormalTok{, }
                       \AttributeTok{keep=}\ConstantTok{FALSE}\NormalTok{, }\AttributeTok{antimeridian=}\ConstantTok{FALSE}\NormalTok{)}
\NormalTok{bathy.df }\OtherTok{\textless{}{-}} \FunctionTok{fortify}\NormalTok{(bathy) }\CommentTok{\# LI: maybe this is not needed here}

\NormalTok{df}\SpecialCharTok{$}\NormalTok{Depth }\OtherTok{\textless{}{-}} \FunctionTok{get.depth}\NormalTok{(bathy, df[,}\FunctionTok{c}\NormalTok{(}\StringTok{"Lon"}\NormalTok{,}\StringTok{"Lat"}\NormalTok{)], }\AttributeTok{locator=}\NormalTok{F)}\SpecialCharTok{$}\NormalTok{depth}
\end{Highlighting}
\end{Shaded}

\hypertarget{operations-with-rasters-maybe-not-needed}{%
\section{Operations with rasters (maybe not needed)}\label{operations-with-rasters-maybe-not-needed}}

We can complete this a bit more later on, though not necessary right now

for example, given a raster, we can calculate gradients in the vertical or depth at which the max is found

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Auxiliary functions {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# Taken from: }
\CommentTok{\# https://gis.stackexchange.com/questions/114723/subset{-}netcdf{-}based{-}on{-}last{-}valid{-}variable{-}by{-}level}

\CommentTok{\# deepestValid: function to that, for each cell,  }
\CommentTok{\# {-} returns NA in case all depth level values are NA}
\CommentTok{\# {-} returns the value of the last available depth level in case no NA occur}
\CommentTok{\# {-} else returns the value of the last non{-}NA depth level}

\NormalTok{deepestValid }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  na }\OtherTok{\textless{}{-}} \FunctionTok{is.na}\NormalTok{(x)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{all}\NormalTok{(na)) \{}
    \FunctionTok{return}\NormalTok{(}\ConstantTok{NA}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{all}\NormalTok{(}\SpecialCharTok{!}\NormalTok{na)) \{}
    \FunctionTok{return}\NormalTok{(x[}\FunctionTok{length}\NormalTok{(x)])}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    first\_na }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(na)[}\DecValTok{1}\NormalTok{]}
\NormalTok{    last\_valid }\OtherTok{\textless{}{-}}\NormalTok{ first\_na }\SpecialCharTok{{-}} \DecValTok{1}
    \FunctionTok{return}\NormalTok{(x[last\_valid])}
\NormalTok{  \}}
\NormalTok{\}}

\CommentTok{\# read the data files using the library raster}

\NormalTok{b1 }\OtherTok{\textless{}{-}} \FunctionTok{brick}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(hdata.dir, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"thetao\_"}\NormalTok{,dd, }\StringTok{" 12:00:00.nc"}\NormalTok{)))}
\NormalTok{b2 }\OtherTok{\textless{}{-}} \FunctionTok{brick}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(hdata.dir, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"so\_"}\NormalTok{,dd, }\StringTok{" 12:00:00.nc"}\NormalTok{)))}
\NormalTok{b3 }\OtherTok{\textless{}{-}} \FunctionTok{brick}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(hdata.dir, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"mlotst\_"}\NormalTok{,dd, }\StringTok{" 12:00:00.nc"}\NormalTok{)))}
\NormalTok{b4 }\OtherTok{\textless{}{-}} \FunctionTok{brick}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(hdata.dir, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"chl\_"}\NormalTok{,dd, }\StringTok{" 12:00:00.nc"}\NormalTok{)))}
\NormalTok{b5 }\OtherTok{\textless{}{-}} \FunctionTok{brick}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(hdata.dir, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"o2\_"}\NormalTok{,dd, }\StringTok{" 12:00:00.nc"}\NormalTok{))) }

\CommentTok{\# temperature at surface (exactly at 0.49m)}
\CommentTok{\# see names(b1)}

\NormalTok{bb1a }\OtherTok{\textless{}{-}}\NormalTok{ b1[[}\DecValTok{1}\NormalTok{]] }
\FunctionTok{names}\NormalTok{(bb1a) }\OtherTok{\textless{}{-}} \StringTok{"TEMP0m"}  

\CommentTok{\# temperature at 100m (layer 22, which is at 92.33m) or at the deepest available }
\CommentTok{\# see names(b1)}

\NormalTok{bb1b }\OtherTok{\textless{}{-}} \FunctionTok{calc}\NormalTok{(}\FunctionTok{subset}\NormalTok{(b1, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{22}\NormalTok{), }\AttributeTok{fun=}\NormalTok{deepestValid)}
\FunctionTok{names}\NormalTok{(bb1b) }\OtherTok{\textless{}{-}} \StringTok{"TEMP100m"} 

\CommentTok{\# salinity at surface (exactly at 0.49m)}
\CommentTok{\# see names(b2)}

\NormalTok{bb2 }\OtherTok{\textless{}{-}}\NormalTok{ b2[[}\DecValTok{1}\NormalTok{]] }
\FunctionTok{names}\NormalTok{(bb2) }\OtherTok{\textless{}{-}} \StringTok{"so1"}  

\CommentTok{\# logarithm of ocean mixed layer thickness (m)}

\NormalTok{bb3 }\OtherTok{\textless{}{-}}\NormalTok{ b3[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{bb3 }\OtherTok{\textless{}{-}} \FunctionTok{log}\NormalTok{(bb3)}
\CommentTok{\# or equivalently:}
\CommentTok{\# bb3 \textless{}{-} calc(bb3, fun=function(x) \{log(x)\})}
\FunctionTok{names}\NormalTok{(bb3) }\OtherTok{\textless{}{-}} \StringTok{"logmlotst1"}

\CommentTok{\# logarithm of the chlorophyll integrated until 100m (layer 22, which is at 92.33m) or at the deepest available }
\CommentTok{\# see names(b4)}

\NormalTok{b4 }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(b4, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{22}\NormalTok{) }\CommentTok{\# take only values in the first 22 layers corresponding up to depth 100m }
\NormalTok{depth.lev }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(b4), substring, }\AttributeTok{first=}\DecValTok{2}\NormalTok{))) }\CommentTok{\# extract depth values from layer names}
\NormalTok{depth.lev }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, depth.lev)}
\NormalTok{w }\OtherTok{\textless{}{-}} \FunctionTok{diff}\NormalTok{(depth.lev) }
\NormalTok{bb4 }\OtherTok{\textless{}{-}} \FunctionTok{calc}\NormalTok{(b4, }\ControlFlowTok{function}\NormalTok{(x)\{}\FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{*}\NormalTok{w, }\AttributeTok{na.rm=}\NormalTok{T)\}) }\CommentTok{\# compute integrated value}
\NormalTok{bb4 }\OtherTok{\textless{}{-}} \FunctionTok{log}\NormalTok{(bb4)}
\FunctionTok{names}\NormalTok{(bb4) }\OtherTok{\textless{}{-}} \StringTok{"logCHL100m"}

\CommentTok{\# oxygen integrated until 100m (layer 22, which is at 92.33m) or at the deepest available }
\CommentTok{\# see names(b5)}

\NormalTok{b5 }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(b5, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{22}\NormalTok{) }\CommentTok{\# take only values in the first 22 layers corresponding up to depth 100m}
\NormalTok{depth.lev }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(b5), substring, }\AttributeTok{first=}\DecValTok{2}\NormalTok{))) }\CommentTok{\# extract depth values from layer names}
\NormalTok{depth.lev }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, depth.lev)}
\NormalTok{w }\OtherTok{\textless{}{-}} \FunctionTok{diff}\NormalTok{(depth.lev)}
\NormalTok{bb5 }\OtherTok{\textless{}{-}} \FunctionTok{calc}\NormalTok{(b5, }\ControlFlowTok{function}\NormalTok{(x)\{}\FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{*}\NormalTok{w, }\AttributeTok{na.rm=}\NormalTok{T)\}) }\CommentTok{\# compute integrated value}
\FunctionTok{names}\NormalTok{(bb5) }\OtherTok{\textless{}{-}} \StringTok{"O100m"}

\CommentTok{\# unique stack (because they all have the same extent and resolution)}

\NormalTok{b }\OtherTok{\textless{}{-}} \FunctionTok{stack}\NormalTok{(bb1a, bb1b, bb2, bb3, bb4, bb5)}

\CommentTok{\# Step 2: Add bathymetry {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# get the extent of the raster to extract the corresponding bathymetry}

\NormalTok{e }\OtherTok{\textless{}{-}} \FunctionTok{extent}\NormalTok{(b)}

\CommentTok{\# load bathymetry of the area (get wider limits)}
\CommentTok{\# resolution = 5 (resolucion en minutos, corresponde a 1/12 º) }

\CommentTok{\# mybathy \textless{}{-} getNOAA.bathy(lon1=floor(e@xmin), lon2=ceiling(e@xmax), lat1=floor(e@ymin), lat2=ceiling(e@ymax), }
\CommentTok{\#                          resolution=1, keep=F) }
\CommentTok{\# save(mybathy, file="mybathy.RData")}

\FunctionTok{load}\NormalTok{(}\FunctionTok{file.path}\NormalTok{(}\StringTok{"mybathy.RData"}\NormalTok{))}
     
\CommentTok{\# transform to data frame}

\NormalTok{pred.dat }\OtherTok{\textless{}{-}}\NormalTok{ raster}\SpecialCharTok{::}\FunctionTok{as.data.frame}\NormalTok{(b, }\AttributeTok{xy=}\NormalTok{T)}

\CommentTok{\# include bathymetry into the prediction data frame}

\NormalTok{pred.dat}\SpecialCharTok{$}\NormalTok{DEPTH }\OtherTok{\textless{}{-}} \FunctionTok{get.depth}\NormalTok{(mybathy, pred.dat[ ,}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{,}\StringTok{"y"}\NormalTok{)], }\AttributeTok{locator=}\NormalTok{F)}\SpecialCharTok{$}\NormalTok{depth}
\NormalTok{pred.dat}\SpecialCharTok{$}\NormalTok{DEPTH[pred.dat}\SpecialCharTok{$}\NormalTok{DEPTH}\SpecialCharTok{\textgreater{}=}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}} \ConstantTok{NA}
\NormalTok{pred.dat}\SpecialCharTok{$}\NormalTok{logDEPTH}\OtherTok{\textless{}{-}}\FunctionTok{log}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{pred.dat}\SpecialCharTok{$}\NormalTok{DEPTH)}

\CommentTok{\# transform the bathymetry to raster format }

\NormalTok{b7 }\OtherTok{\textless{}{-}} \FunctionTok{rasterFromXYZ}\NormalTok{(pred.dat[,}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{,}\StringTok{"y"}\NormalTok{,}\StringTok{"logDEPTH"}\NormalTok{)]) }
\FunctionTok{names}\NormalTok{(b7) }\OtherTok{\textless{}{-}} \StringTok{"logDEPTH"}

\CommentTok{\# include the bathymetry raster into the prediction stack}

\NormalTok{b }\OtherTok{\textless{}{-}} \FunctionTok{stack}\NormalTok{(b, b7)}


\CommentTok{\# Step 3: Create latitude, longitude and doy rasters {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# these are needed to predict according to the spatio{-}temporal model}

\NormalTok{b8 }\OtherTok{\textless{}{-}}\NormalTok{ b9 }\OtherTok{\textless{}{-}}\NormalTok{ b10 }\OtherTok{\textless{}{-}}\NormalTok{ b[[}\DecValTok{1}\NormalTok{]] }\CommentTok{\# create rasters with same structure}

\NormalTok{b8[] }\OtherTok{\textless{}{-}} \FunctionTok{coordinates}\NormalTok{(b8)[,}\DecValTok{1}\NormalTok{] }\CommentTok{\#longitude  }
\FunctionTok{names}\NormalTok{(b8) }\OtherTok{\textless{}{-}} \StringTok{"LON"}

\NormalTok{b9[] }\OtherTok{\textless{}{-}} \FunctionTok{coordinates}\NormalTok{(b8)[,}\DecValTok{2}\NormalTok{] }\CommentTok{\#latitude  }
\FunctionTok{names}\NormalTok{(b9) }\OtherTok{\textless{}{-}} \StringTok{"LAT"}

\NormalTok{b10[] }\OtherTok{\textless{}{-}}\NormalTok{ doy }\CommentTok{\# day of the year}
\FunctionTok{names}\NormalTok{(b10) }\OtherTok{\textless{}{-}} \StringTok{"DOY"}

\CommentTok{\# include longitude, latitude and day of the year into the prediction stack, }
\CommentTok{\# they are needed for the spatio{-}temporal model prediction}

\NormalTok{b }\OtherTok{\textless{}{-}} \FunctionTok{stack}\NormalTok{(b, b8, b9, b10)}
\end{Highlighting}
\end{Shaded}

\hypertarget{prepare-final-dataset}{%
\chapter{Prepare final dataset}\label{prepare-final-dataset}}

Bla bla bla

\hypertarget{extract-environmental-data-associated-to-presence-absence-data}{%
\section{Extract environmental data associated to presence-absence data}\label{extract-environmental-data-associated-to-presence-absence-data}}

\hypertarget{exploratory-plots}{%
\section{Exploratory plots}\label{exploratory-plots}}

\hypertarget{shape-constrained-generalized-additive-models}{%
\chapter{Shape Constrained-Generalized Additive Models}\label{shape-constrained-generalized-additive-models}}

One citation is \citep{citores_etal_2020}

Mention there is an alternative using \texttt{mboost} that won't be further developed here.

\hypertarget{loading-required-libraries}{%
\subsection{Loading required libraries}\label{loading-required-libraries}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(scam)}
\CommentTok{\#library(mgcv)}
\FunctionTok{library}\NormalTok{(plotmo)}
\FunctionTok{library}\NormalTok{(rgdal)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(fields) }\CommentTok{\#imageplot}
\FunctionTok{library}\NormalTok{(maps) }\CommentTok{\#map world}
\FunctionTok{library}\NormalTok{(raster)}
\FunctionTok{library}\NormalTok{(RColorBrewer)}\CommentTok{\#color palette}

\CommentTok{\#SDMTools {-} install RTools and follow: https://cran.r{-}project.org/bin/windows/Rtools/}
\CommentTok{\#install.packages("remotes")}
\CommentTok{\#remotes::install\_version("SDMTools", "1.1{-}221.2")}
\FunctionTok{library}\NormalTok{(SDMTools)}
\FunctionTok{library}\NormalTok{(dismo)}
\FunctionTok{library}\NormalTok{(stringr)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-fit}{%
\section{Model fit}\label{model-fit}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#NOTA INTERNA: aquí hay que cargar el RData de presencias y pseudoausencias que creemos en 05\_data\_final de momento he copido los datos de PA de la anchoa para poder correr el código. Habrá que cambiar status por el nomnbre de la columna de presencia{-}pseudoausencia y el nombre de las variables, en este caso lo hacemos para la anchoa con todas las variables que tenemos: }

\CommentTok{\#Load presence{-}absence dataset of the species}

\FunctionTok{load}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{ (}\StringTok{"data"}\NormalTok{, }\StringTok{"outputs\_for\_modelling"}\NormalTok{, }\StringTok{"PA.Rdata"}\NormalTok{))}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ SP11 }\CommentTok{\#NOTA INTERNA: así se llama el RData de la anchoa}


\NormalTok{raw\_model }\OtherTok{\textless{}{-}} \FunctionTok{scam}\NormalTok{ (status }\SpecialCharTok{\textasciitilde{}}  \FunctionTok{s}\NormalTok{(temp.v, }\AttributeTok{k=}\DecValTok{8}\NormalTok{,}\AttributeTok{bs=}\StringTok{"cv"}\NormalTok{, }\AttributeTok{m=}\DecValTok{2}\NormalTok{)}\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(sal.v, }\AttributeTok{k=}\DecValTok{8}\NormalTok{,}\AttributeTok{bs=}\StringTok{"cv"}\NormalTok{, }\AttributeTok{m=}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(nit.v, }\AttributeTok{k=}\DecValTok{8}\NormalTok{,}\AttributeTok{bs=}\StringTok{"cv"}\NormalTok{, }\AttributeTok{m=}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(npp.v, }\AttributeTok{k=}\DecValTok{8}\NormalTok{,}\AttributeTok{bs=}\StringTok{"cv"}\NormalTok{, }\AttributeTok{m=}\DecValTok{2}\NormalTok{)}\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(dist\_seabed.v, }\AttributeTok{k=}\DecValTok{8}\NormalTok{,}\AttributeTok{bs=}\StringTok{"cv"}\NormalTok{, }\AttributeTok{m=}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(mld\_relative\_position.v, }\AttributeTok{k=}\DecValTok{8}\NormalTok{,}\AttributeTok{bs=}\StringTok{"cv"}\NormalTok{, }\AttributeTok{m=}\DecValTok{2}\NormalTok{), }\AttributeTok{family=}\FunctionTok{binomial}\NormalTok{(}\AttributeTok{link=}\StringTok{"logit"}\NormalTok{), }\AttributeTok{data=}\NormalTok{data)}


\CommentTok{\#Check raw model which contains all variables}
\FunctionTok{summary}\NormalTok{(raw\_model)}
\FunctionTok{scam.check}\NormalTok{(raw\_model)}
\FunctionTok{plot}\NormalTok{(raw\_model)}
\FunctionTok{plotmo}\NormalTok{(raw\_model,}\AttributeTok{level =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{pt.col=}\DecValTok{8}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-selection}{%
\section{Model selection}\label{model-selection}}

\hypertarget{source-the-function-for-forward-selection-of-the-variables-developed-by-libaibarriaga-criterium-aic-and-pvalue}{%
\chapter{Source the function for forward selection of the variables developed by libaibarriaga criterium: AIC and pvalue}\label{source-the-function-for-forward-selection-of-the-variables-developed-by-libaibarriaga-criterium-aic-and-pvalue}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{source}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{ (}\StringTok{"function"}\NormalTok{,}\StringTok{"function\_scam\_selection\_optimized.R"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{preparing-data}{%
\section{preparing data}\label{preparing-data}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# selecting the variables to be used in the model }

\CommentTok{\#NOTA INTERNA: añadir el nombre de las variables que tenemos}
\NormalTok{vars }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"temp.v"}\NormalTok{,}
          \StringTok{"sal.v"}\NormalTok{,}
          \StringTok{"nit.v"}\NormalTok{,}
          \StringTok{"dist\_seabed.v"}\NormalTok{,}
          \StringTok{"mld\_relative\_position.v"}\NormalTok{,}
          \StringTok{"npp.v"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\#Code to build SC-GAM model default sp= NULL, k = 8 and plevel = 0.05

\begin{Shaded}
\begin{Highlighting}[]
  \CommentTok{\# apply the model selection function (no limits in the number of terms)}
\NormalTok{  model\_SCGAM }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(}\FunctionTok{modsel.scam}\NormalTok{(}\AttributeTok{basef=}\StringTok{"status \textasciitilde{} 1"}\NormalTok{, }\AttributeTok{vars=}\NormalTok{vars, }\AttributeTok{dat=}\NormalTok{data), }\AttributeTok{silent=}\NormalTok{T) }\CommentTok{\# by default aic.tol=2}

\CommentTok{\#NOTA INTERNA: ¿queremos añadir el if else y asignar un valor de sp en caso de que sp NULL de error?}
\end{Highlighting}
\end{Shaded}

\hypertarget{check-results}{%
\chapter{check results}\label{check-results}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_SCGAM}\SpecialCharTok{$}\NormalTok{svars}
\FunctionTok{sapply}\NormalTok{(model\_SCGAM}\SpecialCharTok{$}\NormalTok{smod, AIC)}
\FunctionTok{sapply}\NormalTok{(model\_SCGAM}\SpecialCharTok{$}\NormalTok{smod, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{summary}\NormalTok{(x)}\SpecialCharTok{$}\NormalTok{dev.expl)}
\FunctionTok{lapply}\NormalTok{(model\_SCGAM}\SpecialCharTok{$}\NormalTok{smod, formula)}
\FunctionTok{lapply}\NormalTok{(model\_SCGAM}\SpecialCharTok{$}\NormalTok{smod, summary)}

\CommentTok{\# see specifically the summary and the plots of the final model after the selection}
\CommentTok{\# note that it is the last element of the list of models}


\FunctionTok{summary}\NormalTok{(selected\_model)}
\FunctionTok{scam.check}\NormalTok{(selected\_model)}
\FunctionTok{plot}\NormalTok{(selected\_model)}
\FunctionTok{plotmo}\NormalTok{(selected\_model,}\AttributeTok{level =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{pt.col=}\DecValTok{8}\NormalTok{)}

\CommentTok{\#Select the last model of the list which is the best model according to AIC and plevel criteria}
\NormalTok{selected\_model }\OtherTok{\textless{}{-}}\NormalTok{ model\_SCGAM}\SpecialCharTok{$}\NormalTok{smod[[}\FunctionTok{length}\NormalTok{(model\_SCGAM}\SpecialCharTok{$}\NormalTok{smod)]]}
\NormalTok{selected\_model}\SpecialCharTok{$}\NormalTok{sp}

\CommentTok{\# Save the model}

\FunctionTok{save}\NormalTok{(selected\_model, }\AttributeTok{file =}\NormalTok{ here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{(}\StringTok{"models/selected\_model.RData"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-validation}{%
\chapter{Model validation}\label{model-validation}}

Bla bla

\hypertarget{loading-required-libraries-1}{%
\subsection{Loading required libraries}\label{loading-required-libraries-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(scam)}
\CommentTok{\#library(mgcv)}
\FunctionTok{library}\NormalTok{(plotmo)}
\FunctionTok{library}\NormalTok{(rgdal)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(fields) }\CommentTok{\#imageplot}
\FunctionTok{library}\NormalTok{(maps) }\CommentTok{\#map world}
\FunctionTok{library}\NormalTok{(raster)}
\FunctionTok{library}\NormalTok{(RColorBrewer)}\CommentTok{\#color palette}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(R.utils) }\CommentTok{\#loadToEnv}

\CommentTok{\#SDMTools {-} install RTools and follow: https://cran.r{-}project.org/bin/windows/Rtools/}
\CommentTok{\#install.packages("remotes")}
\CommentTok{\#remotes::install\_version("SDMTools", "1.1{-}221.2")}
\FunctionTok{library}\NormalTok{(SDMTools)}
\FunctionTok{library}\NormalTok{(dismo)}

\CommentTok{\#plots}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggpubr)}
\FunctionTok{library}\NormalTok{(hrbrthemes) }\CommentTok{\# theme\_ipsum}
\end{Highlighting}
\end{Shaded}

\hypertarget{optimum-threshold}{%
\section{Optimum threshold}\label{optimum-threshold}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#NOTA INTERNA: aquí hay que cargar el RData del modelo, cargo el que se crea con el 06{-}model\_fit para poder correr el código}

\CommentTok{\#Load SC{-}GAM model}

\FunctionTok{load}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{ (}\StringTok{"models"}\NormalTok{, }\StringTok{"selected\_model.Rdata"}\NormalTok{))}

\CommentTok{\#Load species PA data}

\FunctionTok{load}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{ (}\StringTok{"data"}\NormalTok{, }\StringTok{"outputs\_for\_modelling"}\NormalTok{, }\StringTok{"PA.Rdata"}\NormalTok{))}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ SP11 }\CommentTok{\#NOTA INTERNA: así se llama el RData de la anchoa}

  \CommentTok{\# Predict }
\NormalTok{  scgam.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(selected\_model, }\AttributeTok{newdata=}\NormalTok{data, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
  
  \CommentTok{\# Add the prediction to the table}
\NormalTok{  data}\SpecialCharTok{$}\NormalTok{scgam.pred }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(scgam.pred)}
  \FunctionTok{head}\NormalTok{(data)}

  \DocumentationTok{\#\# Optimizing the threshold probability}
\NormalTok{  obs }\OtherTok{\textless{}{-}}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{status}
\NormalTok{  predSCGAM\_P }\OtherTok{\textless{}{-}}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{scgam.pred}
  
  \CommentTok{\# threshold optimizing}
\NormalTok{  myoptim }\OtherTok{\textless{}{-}} \FunctionTok{optim.thresh}\NormalTok{ (obs,predSCGAM\_P)}
\NormalTok{  myoptim}
\end{Highlighting}
\end{Shaded}

\hypertarget{k-fold-validation}{%
\section{k-fold validation}\label{k-fold-validation}}

\hypertarget{validation}{%
\section{VALIDATION --------------------}\label{validation}}

\hypertarget{httpsrpubs.commlibxmdasdmpartone}{%
\chapter{\texorpdfstring{\url{https://rpubs.com/mlibxmda/SDMPartOne}}{https://rpubs.com/mlibxmda/SDMPartOne}}\label{httpsrpubs.commlibxmdasdmpartone}}

Create a df to save validation results

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{validation\_summary }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{6}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
  \CommentTok{\# select the threshold that maximizes the sum of sensitivity and specificity (Jimenez{-}Valverde and Lobo, 2017)}
\NormalTok{  myThreshold }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{((myoptim[[}\StringTok{"max.sensitivity+specificity"}\NormalTok{]])) }
  
  \CommentTok{\# In case, the result is a range (instead of a single value), we select the mean value of the range }

  \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(myThreshold)}\SpecialCharTok{\textgreater{}}\DecValTok{1}\NormalTok{)\{}
    \FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Note that the threshold is the mean of the range:"}\NormalTok{, myThreshold))}
\NormalTok{    myThreshold }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{ (myThreshold) }
\NormalTok{  \} }
  
  \CommentTok{\# accuracy values with all observations}
  \FunctionTok{accuracy}\NormalTok{ (obs, predSCGAM\_P, }\AttributeTok{threshold=}\NormalTok{myThreshold)}
  
  \CommentTok{\# create confusion matrix with all observations}
  \FunctionTok{confusion.matrix}\NormalTok{(obs, predSCGAM\_P, }\AttributeTok{threshold=}\NormalTok{myThreshold)}
  
  \CommentTok{\# isolate the formula  }
\NormalTok{  v\_summary }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(selected\_model)}
  
\NormalTok{  formula }\OtherTok{\textless{}{-}}\NormalTok{ v\_summary[[}\StringTok{"formula"}\NormalTok{]]}
  
  \CommentTok{\# Generating K Groups of presences for k{-}fold cross{-}validation}
  
  \CommentTok{\# cross{-}validation using k{-}fold}
\NormalTok{  k }\OtherTok{\textless{}{-}} \DecValTok{5} \CommentTok{\# Number of groups}
  
  \CommentTok{\# Separate Presences and absences into 2 different objects}
\NormalTok{  Pres   }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(data, status}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}
\NormalTok{  Aus  }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(data, status}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}

  \CommentTok{\# separate the presences and the absences into the k groups}
  \CommentTok{\# LI: I think we could alternatively do it in one go (i.e. without separating presences and absences) using the argument status: kfold(data, k, by=data$status)}
  
\NormalTok{  groups }\OtherTok{\textless{}{-}} \FunctionTok{kfold}\NormalTok{(Pres, k)   }
  \FunctionTok{head}\NormalTok{(groups)}
\NormalTok{  groups2 }\OtherTok{\textless{}{-}} \FunctionTok{kfold}\NormalTok{(Aus, k)}
  \FunctionTok{head}\NormalTok{ (groups2)}
  
  \CommentTok{\# initialise the confusion matrix and the accuracy table: }
\NormalTok{  myCM }\OtherTok{\textless{}{-}} \ConstantTok{NULL} 
\NormalTok{  myACC }\OtherTok{\textless{}{-}} \ConstantTok{NULL}

  \CommentTok{\# loop for each group k}
  
  \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{k) \{}
    
    \FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Results k{-}fold validation: group "}\NormalTok{, j))}
    
    \CommentTok{\# Preparation of Tabla of Training Sites}
\NormalTok{    presencias\_Training }\OtherTok{\textless{}{-}}\NormalTok{ Pres[groups }\SpecialCharTok{!=}\NormalTok{ j,]}
\NormalTok{    ausencias\_Training }\OtherTok{\textless{}{-}}\NormalTok{ Aus[groups2 }\SpecialCharTok{!=}\NormalTok{ j,]}
    
    \CommentTok{\# Join the two tables}
\NormalTok{    puntos\_Training }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(presencias\_Training, ausencias\_Training)}
    
    \CommentTok{\# Model fit}
\NormalTok{    sp }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(selected\_model}\SpecialCharTok{$}\NormalTok{sp)}
    
\NormalTok{    sp }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(sp)}
    
\NormalTok{    selected\_model.sp.j }\OtherTok{\textless{}{-}} \FunctionTok{scam}\NormalTok{ (formula, }\AttributeTok{family=}\FunctionTok{binomial}\NormalTok{(}\AttributeTok{link=}\StringTok{"logit"}\NormalTok{), }
                        \AttributeTok{data=}\NormalTok{puntos\_Training, }\AttributeTok{sp=}\FunctionTok{c}\NormalTok{(sp}\SpecialCharTok{$}\NormalTok{sp))}
    \FunctionTok{summary}\NormalTok{(selected\_model.sp.j)}
    
    \CommentTok{\# Predict Model}
\NormalTok{    muestra\_validacion }\OtherTok{\textless{}{-}}\NormalTok{ Pres[groups }\SpecialCharTok{==}\NormalTok{ j,]     }\CommentTok{\# valores de predict donde las observaciones son presencias}
\NormalTok{    muestra2\_validacion }\OtherTok{\textless{}{-}}\NormalTok{ Aus [groups2 }\SpecialCharTok{==}\NormalTok{ j,]   }\CommentTok{\# valores de predict donde las observaciones son ausencias}
\NormalTok{    puntos\_validacion}\OtherTok{\textless{}{-}}\FunctionTok{rbind}\NormalTok{(muestra\_validacion, muestra2\_validacion)}
    
\NormalTok{    selected\_model.sp.j.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(selected\_model.sp.j, }\AttributeTok{newdata=}\NormalTok{puntos\_validacion, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{    puntos\_validacion}\SpecialCharTok{$}\NormalTok{Pred }\OtherTok{\textless{}{-}}\NormalTok{ selected\_model.sp.j.pred}
    
    \CommentTok{\# Confussion matrix and accuracy table for fold j}
\NormalTok{    obs }\OtherTok{\textless{}{-}}\NormalTok{ puntos\_validacion}\SpecialCharTok{$}\NormalTok{status}
\NormalTok{    predSCGAM }\OtherTok{\textless{}{-}}\NormalTok{ puntos\_validacion}\SpecialCharTok{$}\NormalTok{Pred}
    \CommentTok{\# print(confusion.matrix(obs, predSCGAM, threshold=myThreshold))}
    \CommentTok{\# print(accuracy(obs, predSCGAM, threshold=myThreshold))}
\NormalTok{    myCM }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(myCM, }\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{confusion.matrix}\NormalTok{(obs, predSCGAM, }\AttributeTok{threshold=}\NormalTok{myThreshold))) }\CommentTok{\# columns are: obs0pred0, obs0pred1, obs1pred0, obs1pred1}
\NormalTok{    myACC }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(myACC, }\FunctionTok{accuracy}\NormalTok{(obs, predSCGAM, }\AttributeTok{threshold=}\NormalTok{myThreshold))}
\NormalTok{  \} }\CommentTok{\# end of loop for j}
  
  \CommentTok{\# save threshold}
\NormalTok{  Threshold }\OtherTok{\textless{}{-}}\NormalTok{ myThreshold}
  
  \CommentTok{\# Mean values across k{-}folds}
\NormalTok{  mean\_AUC }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(myACC}\SpecialCharTok{$}\NormalTok{AUC)}
\NormalTok{  mean\_Omision }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(myACC}\SpecialCharTok{$}\NormalTok{omission.rate)}
\NormalTok{  mean\_sensitivity }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(myACC}\SpecialCharTok{$}\NormalTok{sensitivity)}
\NormalTok{  mean\_specificity }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(myACC}\SpecialCharTok{$}\NormalTok{specificity)}
\NormalTok{  mean\_Prop.Corr }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(myACC}\SpecialCharTok{$}\NormalTok{prop.correct)  }
  
  \CommentTok{\# add mean values to the validation summary table for species}
\NormalTok{  validation\_summary[}\DecValTok{1}\NormalTok{,]}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(Threshold,}
\NormalTok{                            mean\_AUC,}
\NormalTok{                            mean\_Omision,}
\NormalTok{                            mean\_sensitivity,}
\NormalTok{                            mean\_specificity,}
\NormalTok{                            mean\_Prop.Corr)}
  
\NormalTok{  validation\_summary.df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(validation\_summary)}

  \FunctionTok{names}\NormalTok{ (validation\_summary.df) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Threshold"}\NormalTok{, }\StringTok{"mean\_AUC"}\NormalTok{, }\StringTok{"mean\_Omision"}\NormalTok{, }\StringTok{"mean\_sensitivity"}\NormalTok{,}\StringTok{"mean\_specificity"}\NormalTok{, }\StringTok{"mean\_Prop.Corr"}\NormalTok{)}

  \FunctionTok{head}\NormalTok{(validation\_summary.df)}
\end{Highlighting}
\end{Shaded}

\hypertarget{prediction-and-maps}{%
\chapter{Prediction and maps}\label{prediction-and-maps}}

predict from fitted models and produce maps

  \bibliography{references.bib}

\end{document}
