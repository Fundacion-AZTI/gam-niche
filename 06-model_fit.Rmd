---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Shape Constrained-Generalized Additive Models

One citation is [@citores_etal_2020]

Mention there is an alternative using `mboost` that won't be further developed here.  

### Loading required libraries

```{r, eval=F}
library(scam)
#library(mgcv)
library(plotmo)
library(rgdal)
library(ggplot2)
library(dplyr)
library(fields) #imageplot
library(maps) #map world
library(raster)
library(RColorBrewer)#color palette

#SDMTools - install RTools and follow: https://cran.r-project.org/bin/windows/Rtools/
#install.packages("remotes")
#remotes::install_version("SDMTools", "1.1-221.2")
library(SDMTools)
library(dismo)
library(stringr)
```


## Model fit

```{r, eval=F}
#NOTA INTERNA: aquí hay que cargar el RData de presencias y pseudoausencias que creemos en 05_data_final de momento he copido los datos de PA de la anchoa para poder correr el código. Habrá que cambiar status por el nomnbre de la columna de presencia-pseudoausencia y el nombre de las variables, en este caso lo hacemos para la anchoa con todas las variables que tenemos: 

#Load presence-absence dataset of the species

load(here::here ("data", "outputs_for_modelling", "PA.Rdata"))
data <- SP11 #NOTA INTERNA: así se llama el RData de la anchoa


raw_model <- scam (status ~  s(temp.v, k=8,bs="cv", m=2)+ s(sal.v, k=8,bs="cv", m=2) + s(nit.v, k=8,bs="cv", m=2) + s(npp.v, k=8,bs="cv", m=2)+ s(dist_seabed.v, k=8,bs="cv", m=2) + s(mld_relative_position.v, k=8,bs="cv", m=2), family=binomial(link="logit"), data=data)


#Check raw model which contains all variables
summary(raw_model)
scam.check(raw_model)
plot(raw_model)
plotmo(raw_model,level = 0.95, pt.col=8)
```


## Model selection

# Source the function for forward selection of the variables developed by libaibarriaga criterium: AIC and pvalue

```{r, eval=F}
source(here::here ("function","function_scam_selection_optimized.R"))
```

## preparing data
```{r, eval=F}
# selecting the variables to be used in the model 

#NOTA INTERNA: añadir el nombre de las variables que tenemos
vars <- c("temp.v",
          "sal.v",
          "nit.v",
          "dist_seabed.v",
          "mld_relative_position.v",
          "npp.v")
```

#Code to build SC-GAM model default sp= NULL, k = 8 and plevel  = 0.05
```{r, eval=F}

  # apply the model selection function (no limits in the number of terms)
  model_SCGAM <- try(modsel.scam(basef="status ~ 1", vars=vars, dat=data), silent=T) # by default aic.tol=2

#NOTA INTERNA: ¿queremos añadir el if else y asignar un valor de sp en caso de que sp NULL de error?

```

# check results
```{r, eval=F}
model_SCGAM$svars
sapply(model_SCGAM$smod, AIC)
sapply(model_SCGAM$smod, function(x) summary(x)$dev.expl)
lapply(model_SCGAM$smod, formula)
lapply(model_SCGAM$smod, summary)

# see specifically the summary and the plots of the final model after the selection
# note that it is the last element of the list of models


summary(selected_model)
scam.check(selected_model)
plot(selected_model)
plotmo(selected_model,level = 0.95, pt.col=8)

#Select the last model of the list which is the best model according to AIC and plevel criteria
selected_model <- model_SCGAM$smod[[length(model_SCGAM$smod)]]
selected_model$sp

# Save the model

save(selected_model, file = here::here("models/selected_model.RData"))

```
