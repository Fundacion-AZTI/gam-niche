---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Presence-absence data

Bla bla bla

## Download presence data

Download from GBIF OBIS. Mireia

```{r, eval=F}
# Script information ------------------------------------------------------

# Title: Download OBIS/GBIF occurrence data used in H2020 Mission Atlantic (No 862428) Project Task 3.4.
# Last modified by Mireia Valle (github profile: MireiaValle, email: mvalle@azti.es) based on original code for sourcing OBIS and GBIF from Guillem Chust (email: gchust@azti.es) and some adaptations from Eduardo Ramirez. 

# Load libraries 
---------------------------------
  
# Specific libraries to get the occurrence data
#install.packages("robis") # https://cran.r-project.org/web/packages/robis/robis.pdf
library(robis)
library (rgbif)

# Libraries for Spatial data 
library(rgdal)
library(sf) # shapes

# Library for plotting
library(ggplot2)

# Libraries for reading data
library(data.table)
library(dplyr)
library(tidyr)

# outliers
library(CoordinateCleaner)

# Library for reproducible workflow
library(here)
library(rstudioapi)

#library for worl map
library(maptools)


# location of script
setwd(dirname(getSourceEditorContext()$path))

# general settings for ggplot (black-white background, larger base_size)
theme_set(theme_bw(base_size = 16))


# STUDY AREA
---------------------------------

##NOTA interna: En el código de MISSION uso el shapefile de FAO que lo tengo descargado en el ordenador, hay que añadir la info para la descarga manual o el código para la descarga con R. Para MISSION elimino el Black Sea del área de estudio. 
  
# el enlace para la descarga del shapefile es el siguiente: 
 
# http://www.fao.org/fishery/geoserver/fifao/ows?service=WFS&request=GetFeature&version=1.0.0&typeName=fifao:FAO_AREAS_CWP&outputFormat=SHAPE-ZIP")
  
#añado codigo para descargar el shapefile y descomprimirlo, pero no extactamente el mismo shp que tiene mireia, asiq de momento queda comentado sin usar

# url<-"https://www.fao.org/fishery/geoserver/area/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=area%3AFAO_AREAS&maxFeatures=50&outputFormat=SHAPE-ZIP"
# download.file(url,"data/FAO_AREAS.zip",mode="wb")
# unzip("data/FAO_AREAS.zip",exdir="data/spatial")

# Load FAO (spatial multipolygon)
FAO<- st_read(file.path("data", "spatial", "FAO_AREAS.shp"))

#Selecting Atlantic FAO regions
FAO_Atl <- FAO[FAO$OCEAN=="Atlantic",]

#Plot Atlantic FAO regions
plot(FAO_Atl)

#remove Black Sea subarea

Black_Sea <- FAO_Atl[FAO_Atl$ID=="20",]

plot(Black_Sea)

## Find the 'difference', i.e. reverse of st_intersection

# transform to sf object
Black_Sea.sf <- st_as_sf(Black_Sea)

FAO_Atl.sf <- st_as_sf(FAO_Atl)

# remove the black see
FAO_Atl_no_black_sea <- st_difference(FAO_Atl.sf,Black_Sea.sf) %>%   dplyr::select (F_AREA)

#transform to spatial polygons dataframe
FAO_Atl_no_black_sea <- sf:::as_Spatial(FAO_Atl_no_black_sea)

plot(FAO_Atl_no_black_sea)

# DOWNLOAD DATA FROM OBIS AND GBIF DATASETS AND MERGE 
---------------------------------  
  
# en la reunión decidimos hacer pruebas con: Thunnus alalunga, Thunnus obesus, Xiphias gladius y Thunnus albacares
  
## Find data by scientific name in the datasets OBIS/GBIF
  
  # Get data from OBIS
  mydata.obis<-robis::occurrence(scientificname="Thunnus alalunga")

  # Get data from GBIF
  mydata.gbif<-occ_data(scientificName="Thunnus alalunga", hasCoordinate = TRUE, limit=100000)$data
  
  # Select columns of interest from downloaded data
  
  #check names in for obis data
  names(mydata.obis)
  
  #select columns of interest
  mydata.obis <-  mydata.obis %>%
                  dplyr::select("scientificName",
                   "decimalLongitude",
                   "decimalLatitude",
                   "date_year",
                   "month",
                   "day",
                   "eventDate",
                   "depth",
                   "bathymetry",
                   "occurrenceStatus",
                   "sst")
  
  # check names for gbif data
  names(mydata.gbif)
  
  #select columns of interest
  mydata.gbif <- mydata.gbif %>%
                  dplyr::select("acceptedScientificName",
                   "decimalLongitude",
                   "decimalLatitude",
                   "year",
                   "month",
                   "day",
                   "eventDate",
                   "depth")
  
  ## Add new field and rename some columns from mydata.gbif dataframe in order to have the same columns and be able to join both tables
  
  mydata.gbif <- mydata.gbif %>% 
    dplyr::rename(scientificName= "acceptedScientificName") %>% 
    dplyr::rename(date_year = "year") %>% 
    dplyr::mutate(bathymetry= NA) %>% 
    dplyr::mutate(occurrenceStatus=1) %>% 
    dplyr::mutate(sst= NA)

  ## Join data from OBIS and GBIF 
  mydata.fus<-rbind(mydata.obis,mydata.gbif)
  
  ## assign unique scientific name 
  mydata.fus <- mydata.fus %>% 
    dplyr::mutate(scientificName= paste(mydata.obis$scientificName[1]))
  
# CLEAN RAW DATA 
---------------------------------    
  
  #### give date format to eventDate and fill out month and date_year columns
  mydata.fus$eventDate <- as.Date(mydata.fus$eventDate)
  mydata.fus$date_year <- as.numeric(mydata.fus$date_year)
  mydata.fus$month <- as.numeric(mydata.fus$month)

  ### mutate occurrenceStatus column giving value of 1 to presences and 0 to absences
  mydata.fus <- mydata.fus %>% 
    mutate(occurrenceStatus = ifelse(occurrenceStatus== "NA", NA, occurrenceStatus)) %>%
    mutate(occurrenceStatus = ifelse(occurrenceStatus== "Present", 1, occurrenceStatus)) %>% 
    mutate(occurrenceStatus = ifelse(occurrenceStatus== "present", 1, occurrenceStatus)) %>% 
    mutate(occurrenceStatus = ifelse(occurrenceStatus== "Presente", 1, occurrenceStatus)) %>% 
    mutate(occurrenceStatus = ifelse(occurrenceStatus== "Presence", 1, occurrenceStatus)) %>% 
    mutate(occurrenceStatus = ifelse(occurrenceStatus== "P", 1, occurrenceStatus)) %>% 
    mutate(occurrenceStatus = ifelse(occurrenceStatus== "Q", 1, occurrenceStatus))

  ### Assign 1 value to all retrieved points 
  
  #NOTA INTERNA: replace_na me da error por eso asigno directamente 1 a todos los puntos
  mydata.fus <- mydata.fus  %>% 
    dplyr::mutate(occurrenceStatus = 1)

# REMOVING OUTLIERS
---------------------------------  

  # find outliers based on distance method
  out.dist <- cc_outl(x=mydata.fus,
                lon = "decimalLongitude", lat = "decimalLatitude",
                species = "scientificName",
                method="distance", tdi=1000, # distance method with tdi=1000km
                thinning=T, thinning_res=0.5,
                value="flagged") 

  # remove outliers from the data
  
  mydata.fus <- mydata.fus[out.dist, ]
  
# REMOVE DUPLICATES
---------------------------------  
date <- cbind(mydata.fus$decimalLongitude,mydata.fus$decimalLatitude,mydata.fus$eventDate)

mydata.fus<-mydata.fus[!duplicated(date),]

# PREPARE DATA TO USE FAO ATLANTIC REGION MASK
---------------------------------    
    
  # Prepare coordinate format and projection to be able to use FAO zone masks
  dat <- data.frame(cbind(mydata.fus$decimalLongitude,mydata.fus$decimalLatitude))
  ptos<-as.data.table(dat,keep.columnnames=TRUE)
  
  coordinates(ptos) <- ~ X1 + X2
  
  proj4string(ptos) <-proj4string(FAO_Atl_no_black_sea)
  
  ## Select only occurrences from FAO Atlantic
  match2<-data.frame(subset(mydata.fus,!is.na(over(ptos, FAO_Atl_no_black_sea)[,1])))
  
  ## Extract the FAO area of each point
  match3<-data.frame(subset(over(ptos, FAO_Atl_no_black_sea), !is.na(over(ptos, FAO_Atl_no_black_sea)[,1])))
  
  # create data frame with area, name, lon, lat and year 
  df0<-cbind(F_AREA=match3$F_AREA,match2)[,c("F_AREA","scientificName","decimalLongitude","decimalLatitude","date_year","occurrenceStatus")]
  
  #rename some columns
  names(df0)[3:5]<-c("LON","LAT","YEAR")
  
  # add bathymetry from NOAA
  library(marmap)

  bathy <- getNOAA.bathy(lon1=-100,lon2=30,lat1=-41,lat2=55, resolution = 1, 
                       keep=FALSE, antimeridian=FALSE)

  df0$bathymetry <- get.depth(bathy, df0[,c("LON","LAT")], locator=F)$depth


# SAVE OCCURRENCE DATA
---------------------------------    

#NOTA INTERNA: quiero guardar el RData en la carpeta data/occurrences con el nombre de la especies sin espacios para no machar los RData en caso de que hagamos más de una especie pero no lo consigo. 

# lo dejo como esta, asi luego al cargar los datos no hay que poner el nombre de la especie y es mas sencillo

save(df0, file = "data/occurrences/occ.RData")
save(FAO_Atl_no_black_sea, file = "data/spatial/total_area.RData")

  
# PLOT OCCURRENCES MAP
---------------------------------   
ggplot() +
   geom_path(data = FAO_Atl_no_black_sea, 
             aes(x = long, y = lat, group = group),
             color = 'gray', size = .2) +
   geom_point(data=df0, aes(x=decimalLongitude, y=decimalLatitude,colour= occurrenceStatus)) 
  
```

## Create pseudo-absence data

Prevalence 50%

See code from ANICHO (mantaining some space around presences). Leire C.

Ref [@barbetmassin_etal_2012]

Copio aqui el codigo de anicho tal cual, luego lo limpiaré para este caso:

```{r, eval=F}
# Script information ------------------------------------------------------

# Title: Generate pseudo-absences for IM-18-ANICHO
# Last modified by Leire Ibaibarriaga (libaibarriaga@azti.es) and Leire Citores (lcitores@azti.es)

# Load libraries ----------------------------------------------------------

library(tidyverse)
library(ggplot2)
library(scales)
library(here)
library(ggridges)

library(maps)        # some basic country maps
library(mapdata)     # higher resolution maps
library(mapproj)
library(marmap)      # access global topography data
library(mapplots)    # ices rectangles
library(sf)
library(gridExtra)
library(lubridate)
library(raster)

# load data-files
#occurrence data
load("data/occurrences/occ.RData")
#map Atlantic without black sea
load("data/spatial/total_area.RData")

#remove points in land
df0<-subset(df0,bathymetry<0)

#use years from 2000 to 2014
df0<- subset(df0, YEAR<=2014 & YEAR>=2000)

# Remove points in south hemisphere (optional)
#prop.table(table(df0$LAT<=0)) #only 22% of obs in the south
#df0<-subset(df0,LAT>0)

# Remove south hemisphere area
#area <- crop(FAO_Atl_no_black_sea, extent(-100, 100, 0, 100))
area <- FAO_Atl_no_black_sea

#convert to spatial point data frame
df<-df0 ; coordinates(df)<- ~LON+LAT
crs(df)<-crs(area)

#convert to sf
area.sf<-st_union(st_as_sf(area))
df.sf<-st_as_sf(df)

ggplot(area.sf) + geom_sf() + geom_sf(data=st_union(df.sf))


dim(df) # 15079    5
head(df)
tail(df)
summary(df)

# Maps --------------------------------------------------------------------

# basic ggplot

global <- map_data("worldHires")

p0 <- ggplot() + 
  annotation_map(map=global, fill="grey")+
  geom_sf(data=area.sf,fill=NA)
print(p0)

# EGSP: Transformation to UTM ---------------------------------------------

# function to find your UTM. Taken from Nerea Goikoetxea

lonlat2UTM = function(lonlat) {
  utm = (floor((lonlat[1] + 180) / 6) %% 60) + 1
  if(lonlat[2] > 0) {
    utm + 32600
  } else{
    utm + 32700
  }
}

EPSG_2_UTM <- lonlat2UTM(c(mean(df$LON), mean(df$LAT))) 
EPSG_2_UTM # 32623

# transform to UTMs (in m)
aux <- st_transform(area.sf, EPSG_2_UTM)
df.sf.utm <- st_transform(df.sf, EPSG_2_UTM)

# number of points within the study area

df.in <- st_intersects(df.sf.utm, aux, sparse=FALSE)
df$INSIDE <- df.in[,1]
mean(df$INSIDE) # 100% points inside the area of study

# create buffers of 10km (10000) around the points and join the resulting polygons

buffer <- st_buffer(df.sf.utm, dist=100000)
buffer <- st_union(buffer)

p0 + geom_sf(data=buffer)

p <- p0 +
  geom_sf(data=buffer, fill="blue")+
  coord_sf(xlim=c(-90,-82), ylim=c(25,31))
print(p)

# intersect the result with the buffers around the catch data points
aux0 <- st_difference(aux, buffer)

# ggplot for all data

p <- p0 +
  geom_sf(data=aux0, fill=2)+
  coord_sf(xlim=c(-95,-82), ylim=c(25,31))
print(p)

p<-p0 + geom_sf(data=aux0,fill=2)

ggsave(file.path("plots","pseudo",paste0("area_pseudo_all.png")), p, device="png")


# Generate pseudo-absences -------------------------------------------------


# Generate the pseudo-absence data frame

pseudo <- matrix(data=NA, nrow=dim(df0)[1], ncol=dim(df0)[2])
pseudo <- data.frame(pseudo)
names(pseudo) <- names(df0)

# set the seed

set.seed(1)

##no loop

buffer.sub <- st_buffer(df.sf.utm, dist=100000)
buffer.sub <- st_union(buffer.sub)
aux0.sub <- st_difference(aux, buffer.sub)
rp.sf <- st_sample(aux0.sub, size=dim(df.sf.utm)[1], type="random") # randomly sample points
rp.sf <- st_transform(rp.sf, 4326)
rp <- as.data.frame(st_coordinates(rp.sf)) # transform to lat&lon and extract coordinates as data.frame
pseudo$LON <- rp$X
pseudo$LAT <- rp$Y
p <- p0 +
  geom_sf(data=aux0.sub, fill=2, alpha=0.3)+
  geom_sf(data=rp.sf, col=1, shape=4,size=0.5)+
  geom_sf(data=df.sf.utm, col=4, alpha=0.3)+
  ggtitle(paste(unique(df$scientificName),"all"))
ggsave(file.path("plots","pseudo",paste0("pseudo_","all",".png")), p, device="png")


p <- p0 +
  geom_sf(data=aux0.sub, fill=NA, alpha=0.3)+
  geom_sf(data=df.sf.utm, col=4, alpha=0.3,size=0.5)+
  geom_sf(data=rp.sf, col=1, shape=4,size=0.5)+
  coord_sf(xlim=c(-98,-79), ylim=c(15,31))+
  ggtitle(paste(unique(df$scientificName),"all"))
ggsave(file.path("plots","pseudo",paste0("pseudo_","all_zoom",".png")), p, device="png")


# complete the rest of columns

pseudo$scientificName <- df0$scientificName
pseudo$occurrenceStatus  <- 0



# Save the final dataset including the pseudo-absences --------------------

head(df0)
head(pseudo)

# Join the two data sets and save the final dataset

dat <- rbind(df0, pseudo)
save(list=c("dat"),file=file.path("data","outputs_for_modelling",file="PAdata.RData"))
save(list=c("area"),file=file.path("data","spatial",file="area.RData"))
write.table(dat, file=file.path("data","outputs_for_modelling","PAdata.csv"), row.names=F, sep=";", dec=".")

End of script -----------------------------------------------------------
  
  ```



